# 山记事 App - 数据模型与存储设计文档

**版本:** 1.0
**日期:** 2025-01-27
**基于:** 架构设计文档 v2.0
**技术栈:** Expo + React Native + TypeScript + SQLite

## 目录
1.  [引言](#1-引言)
    1.1. [文档目的](#11-文档目的)
    1.2. [范围](#12-范围)
    1.3. [参考资料](#13-参考资料)
2.  [数据模型概述](#2-数据模型概述)
    2.1. [核心实体](#21-核心实体)
    2.2. [实体关系图 (ERD)](#22-实体关系图-erd)
3.  [SQLite 数据库集成与详细数据表设计](#3-sqlite-数据库集成与详细数据表设计)
    3.1. [tasks (任务表)](#31-tasks-任务表)
    3.2. [projects (项目/清单表)](#32-projects-项目清单表)
    3.3. [notes (笔记表)](#33-notes-笔记表)
    3.4. [notebooks (笔记本/文件夹表)](#34-notebooks-笔记本文件夹表)
    3.5. [tags (标签表)](#35-tags-标签表)
    3.6. [note_tags (笔记标签关联表)](#36-note_tags-笔记标签关联表)
    3.7. [sync_metadata (同步元数据表)](#37-sync_metadata-同步元数据表)
    3.8. [note_versions (笔记版本历史表)](#38-note_versions-笔记版本历史表)
    3.9. [task_time_logs (任务时间日志表)](#39-task_time_logs-任务时间日志表)
    3.10. [attachments (附件表)](#310-attachments-附件表)
4.  [数据验证规则](#4-数据验证规则)
5.  [大文件存储 (`expo-file-system` 与 `attachments` 表)](#5-大文件存储-expo-file-system-与-attachments-表)
6.  [敏感数据存储 (`expo-secure-store`)](#6-敏感数据存储-expo-secure-store)
7.  [数据迁移策略](#7-数据迁移策略)
8.  [数据备份与恢复](#8-数据备份与恢复)

---

## 1. 引言

### 1.1. 文档目的
本文档旨在详细描述"山记事"App的本地数据模型、数据库表结构以及数据存储和管理策略。它是数据库实现、数据访问层开发以及后续数据维护的主要依据。

### 1.2. 范围
本文档涵盖：
*   核心数据实体的定义及其关系。
*   SQLite数据库中每个表的详细结构，包括字段、数据类型、约束和索引。
*   使用 `expo-file-system` 和 `expo-secure-store` 的策略。
*   数据验证、迁移、备份和恢复的指导方针。

### 1.3. 参考资料
*   "山记事"App 需求文档 V0.3
*   "山记事"App 架构设计文档 V2.0

## 2. 数据模型概述

### 2.1. 核心实体
应用的核心数据实体包括：
*   **Task (任务):** 用户创建的待办事项。
*   **Project (项目/清单):** 用于组织任务的集合。
*   **Note (笔记):** 用户创建的文本记录。
*   **Notebook (笔记本/文件夹):** 用于组织笔记的集合，支持层级结构。
*   **Tag (标签):** 用于对笔记进行分类和快速检索。
*   **NoteVersion (笔记版本):** 记录笔记的修改历史。
*   **SyncMetadata (同步元数据):** 存储与数据同步服务相关的配置和状态信息。

### 2.2. 实体关系图 (ERD)

```mermaid
erDiagram
    tasks {
        TEXT id PK "唯一标识符 (UUID)"
        TEXT title NOT_NULL "任务标题"
        TEXT description "任务描述"
        INTEGER priority "优先级 (0:低, 1:中, 2:高) - 对应 'low', 'medium', 'high'"
        TEXT due_date "截止日期 (YYYY-MM-DD HH:MM:SS.SSSZ)"
        TEXT completed_at "完成时间 (YYYY-MM-DD HH:MM:SS.SSSZ)"
        TEXT status "任务状态 ('not_started', 'in_progress', 'completed', 'cancelled', 'postponed', 'paused', 'waiting')"
        TEXT created_at NOT_NULL "创建时间 (YYYY-MM-DD HH:MM:SS.SSSZ)"
        TEXT updated_at NOT_NULL "更新时间 (YYYY-MM-DD HH:MM:SS.SSSZ)"
        TEXT project_id FK "所属项目ID (UUID)"
        TEXT parent_task_id FK "父任务ID (UUID)"
        TEXT depends_on_task_id FK "依赖的任务ID (UUID)"
        INTEGER estimated_duration_minutes "预估耗时（分钟）"
        INTEGER actual_duration_minutes "实际耗时（分钟）"
        INTEGER is_recurring "是否重复任务 (0:否, 1:是)"
        TEXT recurrence_rule "重复规则 (iCalendar RRule)"
        INTEGER sort_order "排序顺序 (默认 0)"
        INTEGER sync_status "同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证)"
        TEXT last_synced_at "最后同步时间 (YYYY-MM-DD HH:MM:SS.SSSZ)"
        INTEGER local_version "本地版本号 (默认 1)"
        TEXT remote_version_token "远程版本标识"
        INTEGER is_deleted_locally "标记是否本地已删除 (0:未删除, 1:已删除)"
    }

    projects {
        TEXT id PK "唯一标识符"
        TEXT name NOT_NULL "项目/清单名称"
        TEXT color "自定义颜色"
        TEXT icon "自定义图标"
        TEXT created_at NOT_NULL "创建时间"
        TEXT updated_at NOT_NULL "更新时间"
        INTEGER is_shared "是否共享 (0:否, 1:是)"
        TEXT share_config "共享配置 (JSON)"
        INTEGER sync_status "同步状态"
        INTEGER is_deleted_locally "标记是否本地已删除 (0:未删除, 1:已删除)"
        TEXT last_synced_at "最后同步时间"
        INTEGER local_version "本地版本号"
        TEXT remote_version_token "远程版本标识"
    }

    notes {
        TEXT id PK "唯一标识符"
        TEXT title NOT_NULL "笔记标题"
        TEXT content "笔记内容"
        TEXT content_type "内容类型 ('plain', 'markdown', 'rich')"
        INTEGER is_draft "是否为草稿 (0:否, 1:是)"
        TEXT created_at NOT_NULL "创建时间"
        TEXT updated_at NOT_NULL "更新时间"
        TEXT notebook_id FK "所属笔记本ID"
        INTEGER sync_status "同步状态"
        TEXT last_synced_at "最后同步时间"
        INTEGER local_version "本地版本号"
        TEXT remote_version_token "远程版本标识"
        INTEGER is_deleted_locally "标记是否本地已删除 (0:未删除, 1:已删除)"
    }

    notebooks {
        TEXT id PK "唯一标识符"
        TEXT name NOT_NULL "笔记本/文件夹名称"
        TEXT color "自定义颜色"
        TEXT icon "自定义图标"
        TEXT parent_id FK "父文件夹ID (用于嵌套)"
        TEXT created_at NOT_NULL "创建时间"
        TEXT updated_at NOT_NULL "更新时间"
        INTEGER is_shared "是否共享 (0:否, 1:是)"
        TEXT share_config "共享配置 (JSON)"
        INTEGER sync_status "同步状态"
        INTEGER is_deleted_locally "标记是否本地已删除 (0:未删除, 1:已删除)"
        TEXT last_synced_at "最后同步时间"
        INTEGER local_version "本地版本号"
        TEXT remote_version_token "远程版本标识"
    }

    tags {
        TEXT id PK "唯一标识符"
        TEXT name UNIQUE NOT_NULL "标签名称"
        TEXT color "自定义颜色"
        TEXT created_at NOT_NULL "创建时间"
        INTEGER is_deleted_locally "标记是否本地已删除 (0:未删除, 1:已删除)"
        TEXT updated_at NOT_NULL "更新时间"
        INTEGER sync_status "同步状态"
        TEXT last_synced_at "最后同步时间"
        INTEGER local_version "本地版本号"
        TEXT remote_version_token "远程版本标识"
    }

    note_tags {
        TEXT note_id PK FK "笔记ID"
        TEXT tag_id PK FK "标签ID"
    }

    note_versions {
        TEXT id PK "版本唯一标识符"
        TEXT note_id FK "所属笔记ID"
        TEXT content NOT_NULL "笔记内容快照"
        INTEGER version_number NOT_NULL "版本号 (自增)"
        TEXT created_at NOT_NULL "版本创建时间"
    }
    
    sync_metadata {
        TEXT id PK "元数据唯一标识符 (通常是服务类型)"
        TEXT service_type NOT_NULL "同步服务类型 (e.g., 'google_drive')"
        TEXT last_sync_time "最后成功同步时间"
        TEXT sync_status "当前同步状态 (e.g., 'idle', 'syncing', 'error')"
        TEXT config_data "JSON格式存储服务特定配置"
        TEXT created_at NOT_NULL "创建时间"
        TEXT updated_at NOT_NULL "更新时间"
    }

    tasks ||--o{ projects : "belongs to"
    tasks ||--o{ tasks : "can have sub-tasks (parent_task_id)"
    tasks ||--o{ tasks : "can depend on (depends_on_task_id)"
    notes ||--o{ notebooks : "belongs to"
    notebooks ||--o{ notebooks : "can have sub-notebooks (parent_id)"
    notes }o--o{ note_tags : "has many"
    tags }o--o{ note_tags : "has many"
    notes ||--|{ note_versions : "has versions"
    tasks ||--|{ task_time_logs : "has time logs"
    tasks }o--|| attachments : "can have (owner_type='task')"
    notes }o--|| attachments : "can have (owner_type='note')"
```

## 3. SQLite 数据库集成与详细数据表设计

在 Expo 应用中使用 SQLite 数据库，推荐采用 Expo SDK 内置的 `expo-sqlite` 模块。该模块提供了对 SQLite 数据库的 JavaScript API，允许直接在应用中创建、查询和管理本地数据库。

**选择 `expo-sqlite` 的理由：**
*   **与 Expo 生态集成：** 作为 Expo SDK 的一部分，`expo-sqlite` 无需复杂的原生模块链接或额外配置，易于安装和使用。
*   **跨平台兼容性：** 支持 Expo 所支持的平台 (iOS, Android)。
*   **维护与更新：** 随 Expo SDK 更新而更新，保证了兼容性和稳定性。

**安装与使用：**
通常，可以通过以下命令将 `expo-sqlite` 添加到您的项目中：
```bash
npx expo install expo-sqlite
```
更详细的使用方法和 API 文档，请参考 Expo 官方文档：[https://docs.expo.dev/versions/latest/sdk/sqlite/](https://docs.expo.dev/versions/latest/sdk/sqlite/)

接下来是详细的数据表设计。

所有 `TEXT` 类型的 `id` 字段建议使用 UUID 生成。
所有时间戳 (`created_at`, `updated_at`, `due_date`, `completed_at`, `last_synced_at`, `last_sync_time`) 均存储为 ISO 8601 格式的字符串 (YYYY-MM-DD HH:MM:SS.SSSZ)。
`sync_status`: 0 - 未同步, 1 - 待同步, 2 - 同步中, 3 - 已同步, 4 - 冲突, 5 - 错误, 6 - 等待验证 (例如，需要用户交互解决冲突或认证问题)。

### 3.1. `tasks` (任务表)
存储用户的待办事项。

| 列名                 | 数据类型 | 约束                | 描述                                                                 | 索引     |
| -------------------- | -------- | ------------------- | -------------------------------------------------------------------- | -------- |
| `id`                 | `TEXT`   | `PRIMARY KEY`       | 任务的唯一标识符 (UUID)                                              | 自动     |
| `title`              | `TEXT`   | `NOT NULL`          | 任务标题                                                             |          |
| `description`        | `TEXT`   |                     | 任务的详细描述或备注                                                 |          |
| `priority`           | `INTEGER`| `DEFAULT 0`         | 任务优先级 (0: 低 ('low'), 1: 中 ('medium'), 2: 高 ('high'))             | `idx_task_priority` | 
| `due_date`           | `TEXT`   |                     | 任务的截止日期和时间 (ISO 8601: YYYY-MM-DD HH:MM:SS.SSSZ)             | `idx_task_due_date` |
| `completed_at`       | `TEXT`   |                     | 任务完成的时间戳 (ISO 8601)，NULL表示未完成                           | `idx_task_completed_at` |
| `status`             | `TEXT`   | `DEFAULT 'not_started'` | 任务状态 ('not_started', 'in_progress', 'completed', 'cancelled', 'postponed', 'paused', 'waiting') | `idx_task_status` |
| `created_at`         | `TEXT`   | `NOT NULL`          | 记录创建时间戳 (ISO 8601)                                            |          |
| `updated_at`         | `TEXT`   | `NOT NULL`          | 记录最后更新时间戳 (ISO 8601)                                        |          |
| `project_id`         | `TEXT`   | `REFERENCES projects(id)` | 所属项目/清单的ID (UUID)                                             | `idx_task_project_id` |
| `parent_task_id`     | `TEXT`   | `REFERENCES tasks(id)`   | 父任务ID (UUID)，用于实现子任务                                     | `idx_task_parent_task_id` |
| `depends_on_task_id` | `TEXT`   | `REFERENCES tasks(id)`   | 依赖的任务ID (UUID)                                                  | `idx_task_depends_on_task_id` |
| `estimated_duration_minutes` | `INTEGER` |             | 预估完成任务所需分钟数                                             |          |
| `actual_duration_minutes`    | `INTEGER` |             | 实际完成任务所用分钟数                                             |          |
| `is_recurring`       | `INTEGER`| `NOT NULL DEFAULT 0`| 是否为重复任务 (0: 否, 1: 是)                                       | `idx_task_is_recurring` |
| `recurrence_rule`    | `TEXT`   |                     | 重复规则，如 iCalendar RRule 格式 (e.g., 'FREQ=WEEKLY;BYDAY=MO')      |          |
| `sort_order`         | `INTEGER`| `DEFAULT 0`         | 用于自定义排序的顺序值                                               | `idx_task_sort_order` |
| `sync_status`        | `INTEGER`| `DEFAULT 0`         | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_task_sync_status` |
| `last_synced_at`     | `TEXT`   |                     | 本地记录最后与远程同步成功的时间 (ISO 8601)                          |          |
| `local_version`      | `INTEGER`| `NOT NULL DEFAULT 1`| 本地版本号，每次修改自增                                             |          |
| `remote_version_token`| `TEXT`  |                     | 远程数据版本标识 (如ETag)，用于冲突检测                             |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`| 标记是否本地已删除但尚未同步 (0: 未删除, 1: 已删除)                   | `idx_task_is_deleted_locally`|

**索引 (来自 `lib/database/schema.ts`):**
*   `idx_task_priority` ON `tasks(priority)`
*   `idx_task_due_date` ON `tasks(due_date)`
*   `idx_task_completed_at` ON `tasks(completed_at)`
*   `idx_task_status` ON `tasks(status)`
*   `idx_task_project_id` ON `tasks(project_id)`
*   `idx_task_parent_task_id` ON `tasks(parent_task_id)`
*   `idx_task_depends_on_task_id` ON `tasks(depends_on_task_id)`
*   `idx_task_is_recurring` ON `tasks(is_recurring)`
*   `idx_task_sort_order` ON `tasks(sort_order)`
*   `idx_task_sync_status` ON `tasks(sync_status)`
*   `idx_task_is_deleted_locally` ON `tasks(is_deleted_locally)`
*   `idx_task_search` ON `tasks(title, description)` (复合索引)
*   `idx_task_due_date_status` ON `tasks(due_date, status)` (复合索引)
*   `idx_task_priority_status` ON `tasks(priority, status)` (复合索引)
*   `idx_task_project_status` ON `tasks(project_id, status)` (复合索引)
*   `idx_task_status_deleted` ON `tasks(status, is_deleted_locally)` (复合索引)
*   `idx_task_created_status` ON `tasks(created_at, status)` (复合索引)

### 3.2. `projects` (项目/清单表)
存储用户创建的用于组织任务的清单或项目。

| 列名          | 数据类型 | 约束                | 描述                               | 索引     |
| ------------- | -------- | ------------------- | ---------------------------------- | -------- |
| `id`          | `TEXT`   | `PRIMARY KEY`       | 项目的唯一标识符 (UUID)            | 自动     |
| `name`        | `TEXT`   | `NOT NULL`          | 项目/清单名称                      | `idx_project_name` |
| `color`       | `TEXT`   |                     | 自定义颜色代码 (如 '#RRGGBB')       |          |
| `icon`        | `TEXT`   |                     | 自定义图标标识符                   |          |
| `created_at`  | `TEXT`   | `NOT NULL`          | 记录创建时间戳                     |          |
| `updated_at`  | `TEXT`   | `NOT NULL`          | 记录最后更新时间戳                 |          |
| `sort_order`  | `INTEGER`| `DEFAULT 0`         | 用于自定义排序的顺序值             | `idx_project_sort_order` |
| `is_shared`   | `INTEGER`| `NOT NULL DEFAULT 0`| 是否共享 (0: 否, 1: 是)            | `idx_project_is_shared`|
| `share_config`| `TEXT`   |                     | 共享配置 (JSON格式)                |          |
| `sync_status` | `INTEGER`| `DEFAULT 0`         | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_project_sync_status` |
| `last_synced_at`| `TEXT` |                     | 本地记录最后与远程同步成功的时间   |          |
| `local_version`| `INTEGER`| `NOT NULL DEFAULT 1`| 本地版本号，每次修改自增           |          |
| `remote_version_token`| `TEXT`|                 | 远程数据版本标识                   |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`| 标记是否本地已删除但尚未同步       | `idx_project_is_deleted_locally`|

### 3.3. `notes` (笔记表)
存储用户的笔记内容。

| 列名                 | 数据类型 | 约束                   | 描述                                                                 | 索引     |
| -------------------- | -------- | ---------------------- | -------------------------------------------------------------------- | -------- |
| `id`                 | `TEXT`   | `PRIMARY KEY`          | 笔记的唯一标识符 (UUID)                                              | 自动     |
| `title`              | `TEXT`   | `NOT NULL`             | 笔记标题                                                             |          |
| `content`            | `TEXT`   |                        | 笔记内容 (纯文本、Markdown或富文本HTML)                              |          |
| `content_type`       | `TEXT`   | `DEFAULT 'plain'`      | 内容类型: 'plain', 'markdown', 'rich'                                |          |
| `is_draft`           | `INTEGER`| `NOT NULL DEFAULT 0`   | 是否为草稿 (0: 否, 1: 是)                                           | `idx_note_is_draft` |
| `created_at`         | `TEXT`   | `NOT NULL`             | 记录创建时间戳                                                       |          |
| `updated_at`         | `TEXT`   | `NOT NULL`             | 记录最后更新时间戳                                                   |          |
| `notebook_id`        | `TEXT`   | `REFERENCES notebooks(id)`| 所属笔记本/文件夹的ID                                                | `idx_note_notebook_id` |
| `sync_status`        | `INTEGER`| `DEFAULT 0`            | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_note_sync_status` |
| `last_synced_at`     | `TEXT`   |                        | 本地记录最后与远程同步成功的时间                                     |          |
| `local_version`      | `INTEGER`| `NOT NULL DEFAULT 1`   | 本地版本号，每次修改自增                                             |          |
| `remote_version_token`| `TEXT`  |                        | 远程数据版本标识                                                     |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`   | 标记是否本地已删除但尚未同步                                         | `idx_note_is_deleted_locally`|

### 3.4. `notebooks` (笔记本/文件夹表)
存储用户创建的用于组织笔记的笔记本或文件夹，支持嵌套。

| 列名          | 数据类型 | 约束                   | 描述                                      | 索引     |
| ------------- | -------- | ---------------------- | ----------------------------------------- | -------- |
| `id`          | `TEXT`   | `PRIMARY KEY`          | 笔记本的唯一标识符 (UUID)                 | 自动     |
| `name`        | `TEXT`   | `NOT NULL`             | 笔记本/文件夹名称                         | `idx_notebook_name` |
| `color`       | `TEXT`   |                        | 自定义颜色代码                            |          |
| `icon`        | `TEXT`   |                        | 自定义图标标识符                          |          |
| `parent_id`   | `TEXT`   | `REFERENCES notebooks(id)`| 父文件夹ID，NULL表示顶级文件夹            | `idx_notebook_parent_id` |
| `created_at`  | `TEXT`   | `NOT NULL`             | 记录创建时间戳                            |          |
| `updated_at`  | `TEXT`   | `NOT NULL`             | 记录最后更新时间戳                        |          |
| `sort_order`  | `INTEGER`| `DEFAULT 0`            | 用于自定义排序的顺序值                    | `idx_notebook_sort_order` |
| `is_shared`   | `INTEGER`| `NOT NULL DEFAULT 0`   | 是否共享 (0: 否, 1: 是)                   | `idx_notebook_is_shared`|
| `share_config`| `TEXT`   |                        | 共享配置 (JSON格式)                       |          |
| `sync_status` | `INTEGER`| `DEFAULT 0`            | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_notebook_sync_status` |
| `last_synced_at`| `TEXT` |                        | 本地记录最后与远程同步成功的时间          |          |
| `local_version`| `INTEGER`| `NOT NULL DEFAULT 1`   | 本地版本号，每次修改自增                  |          |
| `remote_version_token`| `TEXT`|                    | 远程数据版本标识                          |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`| 标记是否本地已删除但尚未同步            | `idx_notebook_is_deleted_locally`|

### 3.5. `tags` (标签表)
存储用户创建的用于标记笔记的标签。

| 列名         | 数据类型 | 约束                          | 描述                      | 索引     |
| ------------ | -------- | ----------------------------- | ------------------------- | -------- |
| `id`         | `TEXT`   | `PRIMARY KEY`                 | 标签的唯一标识符 (UUID)   | 自动     |
| `name`       | `TEXT`   | `UNIQUE NOT NULL`             | 标签名称 (大小写不敏感唯一) | `idx_tag_name` |
| `color`      | `TEXT`   |                               | 自定义颜色代码            |          |
| `created_at` | `TEXT`   | `NOT NULL`                    | 记录创建时间戳            |          |
| `updated_at` | `TEXT`   | `NOT NULL`                    | 记录最后更新时间戳        |          |
| `sync_status`| `INTEGER`| `DEFAULT 0`                 | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_tag_sync_status`|
| `last_synced_at`| `TEXT`|                             | 本地记录最后与远程同步成功的时间 |        |
| `local_version`| `INTEGER`| `NOT NULL DEFAULT 1`        | 本地版本号，每次修改自增    |          |
| `remote_version_token`| `TEXT`|                         | 远程数据版本标识            |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`| 标记是否本地已删除但尚未同步  | `idx_tag_is_deleted_locally`|


### 3.6. `note_tags` (笔记标签关联表)
笔记和标签的多对多关系表。

| 列名     | 数据类型 | 约束                                       | 描述     | 索引     |
| -------- | -------- | ------------------------------------------ | -------- | -------- |
| `note_id`| `TEXT`   | `PRIMARY KEY, REFERENCES notes(id) ON DELETE CASCADE` | 笔记ID   | `idx_nt_note_id` |
| `tag_id` | `TEXT`   | `PRIMARY KEY, REFERENCES tags(id) ON DELETE CASCADE`  | 标签ID   | `idx_nt_tag_id`  |

**复合主键:** (`note_id`, `tag_id`)

### 3.7. `sync_metadata` (同步元数据表)
存储与各个同步服务相关的配置和状态。

| 列名             | 数据类型 | 约束             | 描述                                                              | 索引     |
| ---------------- | -------- | ---------------- | ----------------------------------------------------------------- | -------- |
| `id`             | `TEXT`   | `PRIMARY KEY`    | 通常是服务类型，如 'google_drive', 'webdav_main'                   | 自动     |
| `service_type`   | `TEXT`   | `NOT NULL`       | 同步服务类型 (如 'google_drive', 'dropbox', 'webdav')             |          |
| `account_identifier`| `TEXT`|                  | 用户在该服务上的账户标识 (如邮箱，用于区分多账户)                 |          |
| `config_data`    | `TEXT`   |                  | JSON格式字符串，存储服务特定配置 (如文件夹ID, 访问令牌等)        |          |
| `last_sync_time` | `TEXT`   |                  | 最近一次成功完整同步的时间戳                                      |          |
| `sync_status`    | `TEXT`   |                  | 当前同步状态 ('idle', 'syncing', 'error', 'authentication_required') |          |
| `error_message`  | `TEXT`   |                  | 如果同步出错，存储错误信息                                        |          |
| `created_at`     | `TEXT`   | `NOT NULL`       | 记录创建时间戳                                                    |          |
| `updated_at`     | `TEXT`   | `NOT NULL`       | 记录最后更新时间戳                                                |          |

### 3.8. `note_versions` (笔记版本历史表)
存储笔记的修改历史版本（可选功能）。

| 列名            | 数据类型 | 约束                                       | 描述                      | 索引     |
| --------------- | -------- | ------------------------------------------ | ------------------------- | -------- |
| `id`            | `TEXT`   | `PRIMARY KEY`                              | 版本记录的唯一标识符 (UUID) | 自动     |
| `note_id`       | `TEXT`   | `NOT NULL, REFERENCES notes(id) ON DELETE CASCADE` | 所属笔记的ID              | `idx_nv_note_id` |
| `content`       | `TEXT`   | `NOT NULL`                                 | 该版本的笔记内容快照      |          |
| `version_number`| `INTEGER`| `NOT NULL`                                 | 版本号（对于每个笔记自增）|          |
| `created_at`    | `TEXT`   | `NOT NULL`                                 | 版本创建时间戳            |          |

**复合索引:** (`note_id`, `version_number`) 可以考虑设为唯一。

### 3.9. `task_time_logs` (任务时间日志表)
存储任务的详细时间记录。

| 列名            | 数据类型 | 约束                                  | 描述                      | 索引     |
| --------------- | -------- | ------------------------------------- | ------------------------- | -------- |
| `id`            | `TEXT`   | `PRIMARY KEY`                         | 日志唯一标识符 (UUID)     | 自动     |
| `task_id`       | `TEXT`   | `NOT NULL, REFERENCES tasks(id) ON DELETE CASCADE` | 所属任务的ID              | `idx_ttl_task_id` |
| `start_time`    | `TEXT`   | `NOT NULL`                            | 工作开始时间戳            | `idx_ttl_start_time`|
| `end_time`      | `TEXT`   |                                       | 工作结束时间戳            |          |
| `description`   | `TEXT`   |                                       | 工作内容描述              |          |
| `created_at`    | `TEXT`   | `NOT NULL`                            | 日志记录创建时间戳        |          |

### 3.10. `attachments` (附件表)
存储与笔记或任务关联的文件附件信息。

| 列名                 | 数据类型 | 约束                     | 描述                                                                 | 索引     |
| -------------------- | -------- | ------------------------ | -------------------------------------------------------------------- | -------- |
| `id`                 | `TEXT`   | `PRIMARY KEY`            | 附件唯一标识符 (UUID)                                                | 自动     |
| `owner_type`         | `TEXT`   | `NOT NULL`               | 所属实体类型 ('note', 'task')                                        | `idx_att_owner_type` |
| `owner_id`           | `TEXT`   | `NOT NULL`               | 所属实体的ID (关联到 notes.id 或 tasks.id)                         | `idx_att_owner_id` |
| `file_name`          | `TEXT`   | `NOT NULL`               | 原始文件名                                                           |          |
| `local_uri`          | `TEXT`   |                          | 使用 `expo-file-system` 管理的本地文件URI                            |          |
| `remote_url`         | `TEXT`   |                          | 同步到云端后的文件URL                                                |          |
| `mime_type`          | `TEXT`   |                          | 文件的MIME类型                                                       |          |
| `size_bytes`         | `INTEGER`|                          | 文件大小 (字节)                                                      |          |
| `created_at`         | `TEXT`   | `NOT NULL`               | 附件记录创建时间戳                                                   |          |
| `updated_at`         | `TEXT`   | `NOT NULL`               | 附件记录最后更新时间戳                                               |          |
| `sync_status`        | `INTEGER`| `DEFAULT 0`              | 同步状态 (0:未同步, 1:待同步, 2:同步中, 3:已同步, 4:冲突, 5:错误, 6:等待验证) | `idx_att_sync_status` |
| `last_synced_at`     | `TEXT`   |                          | 本地记录最后与远程同步成功的时间                                     |          |
| `local_version`      | `INTEGER`| `NOT NULL DEFAULT 1`     | 本地版本号，每次修改自增                                             |          |
| `remote_version_token`| `TEXT`  |                          | 远程数据版本标识                                                     |          |
| `is_deleted_locally` | `INTEGER`| `NOT NULL DEFAULT 0`     | 标记是否本地已删除但尚未同步 (0: 未删除, 1: 已删除)                | `idx_att_is_deleted_locally`|

**复合索引:** (`owner_type`, `owner_id`) 以便快速查找特定实体下的所有附件。

## 4. 数据验证规则

**基于代码评审的增强要求:**

### 4.1 基础数据验证
*   **`title` (任务、笔记、项目、笔记本):** 不能为空，长度限制 (例如，1-255字符)。
*   **`name` (标签):** 不能为空，长度限制，唯一性 (大小写不敏感处理)。
*   **`due_date` (任务):** 如果设置，必须是有效的日期时间格式。
*   **`priority` (任务):** 必须在预定义的范围内 (0, 1, 2)。
*   **`status` (任务):** 必须是预定义的有效状态之一。
*   **`content_type` (笔记):** 必须是预定义的类型 ('plain', 'markdown', 'rich')。
*   **`parent_id` (笔记本、任务):** 如果设置，必须指向一个存在的对应表中的 `id`，并且不能是自身ID (防止循环)。
*   **`color` (项目、笔记本、标签):** 如果设置，应为有效的颜色代码格式 (如 HEX)。
*   **`owner_type` (附件):** 必须是预定义的类型 (如 'note', 'task')。

### 4.2 业务规则验证
*   **任务状态转换验证:** 
    ```typescript
    const VALID_STATUS_TRANSITIONS = {
      'not_started': ['in_progress', 'cancelled', 'postponed'],
      'in_progress': ['completed', 'paused', 'cancelled'],
      'completed': ['in_progress'], // 允许恢复未完成
      'cancelled': ['not_started', 'in_progress'],
      'postponed': ['not_started', 'in_progress'],
      'paused': ['in_progress', 'cancelled'],
      'waiting': ['in_progress', 'cancelled']
    };
    ```
*   **任务依赖关系验证:** 防止循环依赖，确保依赖的任务存在且有效。
*   **截止日期合理性:** 截止日期不能早于创建日期（除非是历史数据导入）。
*   **优先级与状态一致性:** 已完成任务的优先级变更限制。

### 4.3 数据完整性约束
*   **外键约束验证:** 确保所有外键引用的记录存在且未被软删除。
*   **软删除一致性:** 删除父记录时，相关子记录的处理策略。
*   **版本控制验证:** 本地版本号的单调递增性。

### 4.4 性能相关验证
*   **批量操作限制:** 单次批量操作的记录数量限制（如最多1000条）。
*   **内容长度限制:** 笔记内容、任务描述等的最大长度限制。
*   **附件大小限制:** 单个附件文件的大小限制。

验证应在应用层进行，然后再写入数据库。建议实现统一的验证框架：

```typescript
// 验证框架示例
interface ValidationRule<T> {
  field: keyof T;
  validator: (value: any, context?: T) => boolean | Promise<boolean>;
  message: string;
}

class DataValidator<T> {
  private rules: ValidationRule<T>[] = [];
  
  addRule(rule: ValidationRule<T>): void {
    this.rules.push(rule);
  }
  
  async validate(data: T): Promise<ValidationResult> {
    const errors: string[] = [];
    
    for (const rule of this.rules) {
      const isValid = await rule.validator(data[rule.field], data);
      if (!isValid) {
        errors.push(rule.message);
      }
    }
    
    return {
      isValid: errors.length === 0,
      errors
    };
  }
}
```

## 5. 大文件存储 (`expo-file-system` 与 `attachments` 表)

对于需求中提到的"插入本地图片"到笔记或任务等功能，较大的文件（如图片、未来可能的附件如PDF、音频）不适合直接存储在SQLite数据库的BLOB字段中，因为这会显著影响数据库性能和大小。

我们使用 `attachments` 表来管理这些大文件的元数据，而实际文件则通过 `expo-file-system` 存储在设备的文件系统中。

### 5.1 基础存储策略
*   **文件存储位置:** 使用 `expo-file-system.documentDirectory` 结合一个应用特定的子目录结构，例如 `my-app/attachments/<owner_type>/<owner_id>/<attachment_id_or_filename>`。`attachments.local_uri` 字段将存储指向这个本地文件的URI。
*   **元数据管理:** `attachments` 表负责存储每个文件的详细信息，包括其属主 (哪个笔记或任务)、原始文件名、本地存储路径 (`local_uri`)、MIME类型、大小、创建/更新时间以及同步相关状态。详见 `attachments` 表定义 (章节 3.10)。
*   **文件与记录的关联:** `attachments` 表通过 `owner_type` 和 `owner_id` 字段与 `notes` 表或 `tasks` 表中的记录关联起来。

### 5.2 性能优化策略
*   **文件大小分类存储:**
    ```typescript
    // 小文件 (<1MB): 直接存储
    // 中等文件 (1-10MB): 压缩后存储
    // 大文件 (>10MB): 分块存储
    
    interface FileStorageStrategy {
      shouldCompress(size: number): boolean;
      shouldSplitFile(size: number): boolean;
      getCompressionQuality(mimeType: string): number;
    }
    ```
*   **缓存机制:** 
    - 缩略图缓存：为图片文件生成缩略图
    - 最近访问缓存：LRU缓存常用文件
    - 预加载策略：智能预加载相关文件
*   **懒加载:** 仅在需要时加载文件内容，列表页面只显示文件元信息。

### 5.3 同步策略优化
*   **增量同步:** 仅同步变更的文件，支持断点续传。
*   **优先级同步:** 文本内容优先，附件文件次之。
*   **带宽适配:** 根据网络状况调整同步策略。
*   **冲突处理:** 文件级别的版本控制和冲突解决。

### 5.4 数据清理与维护
*   **定期清理:** 清理孤儿文件、临时文件、过期缓存。
*   **存储优化:** 定期压缩、去重、归档等。
*   **监控统计:** 跟踪存储使用情况、文件访问频率等。

## 6. 敏感数据存储 (`expo-secure-store`)

### 6.1 安全存储策略
用于存储需要加密保护的敏感信息。

*   **存储内容:**
    *   第三方云同步服务的访问令牌 (Access Tokens)、刷新令牌 (Refresh Tokens)。
    *   WebDAV 服务器的用户名和密码。
    *   如果未来实现应用锁，相关的PIN码哈希或生物识别设置凭证。
    *   用户自定义的加密密钥（如果实现端到端加密）。

### 6.2 安全增强措施
*   **键名策略:** 使用清晰、唯一的键名，如 `sync.googledrive.accessToken`, `sync.webdav.mywebdav.password`。
*   **数据加密:** 
    ```typescript
    // 双重加密策略
    class SecureDataManager {
      private async encryptData(data: string, userKey?: string): Promise<string> {
        // 1. 应用层加密
        const appEncrypted = await CryptoJS.AES.encrypt(data, this.getAppSecret());
        
        // 2. 用户密钥加密（可选）
        if (userKey) {
          return await CryptoJS.AES.encrypt(appEncrypted, userKey);
        }
        
        return appEncrypted;
      }
    }
    ```
*   **访问控制:** 
    - 生物识别验证
    - 时间窗口限制
    - 失败尝试锁定

### 6.3 注意事项与备份策略
*   **平台差异:** `expo-secure-store` 在Android上可能因用户清除应用数据或卸载应用而丢失数据。iOS上存储在Keychain中，相对持久。
*   **凭证管理:** 对于同步凭证，应在其过期或用户登出同步服务时及时清除。
*   **备份与恢复:** 
    - 提供凭证备份功能（加密后存储）
    - 支持多设备间凭证同步
    - 应急恢复机制

## 7. 数据迁移策略

### 7.1 版本控制增强
随着应用版本迭代，数据库表结构可能需要变更。

*   **版本控制:** 在应用内维护一个数据库版本号。
*   **向前兼容:** 支持向前兼容的数据库变更。
*   **回滚机制:** 支持数据库版本回滚（有限支持）。

### 7.2 迁移脚本优化
*   **分段式迁移:** 大型迁移分解为多个小步骤。
*   **数据验证:** 迁移后的数据完整性验证。
*   **性能优化:** 
    ```typescript
    // 批量迁移示例
    async function migrateLargeTable(fromVersion: number, toVersion: number) {
      const BATCH_SIZE = 1000;
      let offset = 0;
      
      while (true) {
        const batch = await this.getBatch(offset, BATCH_SIZE);
        if (batch.length === 0) break;
        
        await this.migrateBatch(batch, fromVersion, toVersion);
        offset += BATCH_SIZE;
        
        // 进度报告
        await this.reportProgress(offset);
      }
    }
    ```

### 7.3 迁移安全保障
*   **自动备份:** 迁移前自动创建数据备份。
*   **事务保护:** 迁移过程中的事务完整性。
*   **错误恢复:** 迁移失败时的自动恢复机制。

## 8. 数据备份与恢复

### 8.1 本地备份增强
*   **增量备份:** 
    ```typescript
    interface BackupStrategy {
      type: 'full' | 'incremental' | 'differential';
      frequency: 'daily' | 'weekly' | 'monthly';
      retentionPolicy: number; // 保留份数
      compressionLevel: number; // 压缩级别
    }
    ```
*   **数据完整性验证:** 备份文件的校验和验证。
*   **加密备份:** 敏感数据的加密备份。

### 8.2 智能恢复策略
*   **选择性恢复:** 允许选择恢复特定类型的数据。
*   **合并策略:** 
    - 时间戳优先
    - 用户选择
    - 智能合并
*   **冲突解决:** 恢复时的数据冲突处理。

### 8.3 云备份集成
*   **自动云备份:** 集成到现有同步机制。
*   **版本管理:** 云端备份的版本控制。
*   **恢复验证:** 云备份的完整性验证。

--- 