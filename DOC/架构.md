# 山记事 App - 架构设计文档

**版本:** 3.0
**日期:** 2025-01-27
**作者:** AI助手 (基于Expo + React Native技术栈)
**技术栈:** Expo + React Native + TypeScript + Android

**目录**

1. [引言](#1-引言)
    1.1. [文档目的](#11-文档目的)
    1.2. [范围](#12-范围)
    1.3. [定义与缩写](#13-定义与缩写)
    1.4. [参考资料](#14-参考资料)
2. [架构概述](#2-架构概述)
    2.1. [架构目标](#21-架构目标)
    2.2. [架构风格](#22-架构风格)
    2.3. [高层架构图](#23-高层架构图)
3. [分层架构详解](#3-分层架构详解)
    3.1. [表现层 (Presentation Layer)](#31-表现层-presentation-layer)
    3.2. [应用层 (Application Layer)](#32-应用层-application-layer)
    3.3. [领域层 (Domain Layer)](#33-领域层-domain-layer)
    3.4. [数据层 (Data Layer / Infrastructure Layer)](#34-数据层-data-layer--infrastructure-layer)
4. [模块化设计](#4-模块化设计)
    4.1. [核心库 (`lib/`)](#41-核心库-lib)
    4.2. [应用模块 (`app/`)](#42-应用模块-app)
5. [数据管理](#5-数据管理)
    5.1. [本地数据存储](#51-本地数据存储)
    5.2. [数据访问对象 (DAO)](#52-数据访问对象-dao)
    5.3. [Repository模式](#53-repository模式)
6. [依赖注入与服务管理](#6-依赖注入与服务管理)
    6.1. [服务容器 (`Container.ts`)](#61-服务容器-containerts)
    6.2. [服务注册 (`ServiceRegistry.ts`)](#62-服务注册-serviceregistryts)
    6.3. [应用服务 (`NewAppService.ts`)](#63-应用服务-newappservicets)
7. [事件驱动机制](#7-事件驱动机制)
    7.1. [事件总线 (`EventBus.ts`)](#71-事件总线-eventbusts)
    7.2. [领域事件 (`TaskEvents.ts`, `NoteEvents.ts`)](#72-领域事件-taskeventsts-noteeventsts)
8. [Expo + React Native实现](#8-expo--react-native实现)
9. [非功能性需求实现策略](#9-非功能性需求实现策略)
    9.1. [性能](#91-性能)
    9.2. [安全性](#92-安全性)
    9.3. [可维护性与可扩展性](#93-可维护性与可扩展性)
    9.4. [监控与可观测性](#94-监控与可观测性)
10. [技术栈选型](#10-技术栈选型)
11. [未来展望与演进](#11-未来展望与演进)
12. [迁移总结](#12-迁移总结)

---

## 1. 引言

### 1.1. 文档目的

本文档旨在详细描述"山记事"个人应用的软件架构设计。它将作为开发团队在设计、实现、测试和维护应用时的主要技术指导依据，确保架构决策与项目需求一致，并促进团队成员对系统设计的共同理解。**本文档已根据最新的架构重构完成情况进行更新。**

### 1.2. 范围

本文档涵盖了"山记事"App 的主要架构组件、它们之间的关系、数据管理策略、**新的服务架构、依赖注入机制、事件驱动模型**以及关键技术选型。它侧重于系统的结构和行为，而非具体的实现细节。

### 1.3. 定义与缩写

* **App:** 指代"山记事"应用程序。
* **UI:** 用户界面 (User Interface)。
* **UX:** 用户体验 (User Experience)。
* **API:** 应用程序编程接口 (Application Programming Interface)。
* **SDK:** 软件开发工具包 (Software Development Kit)。
* **SQLite:** 一种轻量级的本地数据库。
* **WebDAV:** 基于 Web 的分布式创作和版本控制协议。
* **DTO:** 数据传输对象 (Data Transfer Object)。
* **DAO:** 数据访问对象 (Data Access Object)。
* **CRUD:** 创建 (Create)、读取 (Read)、更新 (Update)、删除 (Delete)。
* **DI:** 依赖注入 (Dependency Injection)。
* **IoC:** 控制反转 (Inversion of Control)。

### 1.4. 参考资料

* "山记事"App 需求文档 V0.2
* [架构重构完成指南.md](../../Docs/架构重构完成指南.md)
* [迁移完成报告.md](../../Docs/迁移完成报告.md)

## 2. 架构概述

### 2.1. 架构目标

本架构旨在支持以下核心目标：

* **数据隐私与本地优先:** 确保用户数据主要存储在本地，用户对数据有完全控制权。
* **灵活的数据同步:** 提供多种可靠的同步方式，满足不同用户的需求 (未来规划)。
* **跨平台能力:** 优先考虑能够高效实现跨平台部署的方案。
* **简洁易用:** 架构应支持构建直观、高效的用户界面。
* **高内聚低耦合:** 模块和层次之间职责清晰，易于独立开发、测试和维护。
* **可扩展性与可维护性:** 方便未来功能的迭代和代码的长期维护。
* **稳定可靠:** 保证数据操作的原子性和一致性。
* **性能优化:** 支持缓存机制、虚拟化列表、懒加载等性能优化策略。
* **安全性保障:** 集成数据验证、访问控制等安全机制。
* **可测试性:** 支持依赖注入、Mock机制、自动化测试等测试友好设计。
* **监控与日志:** 提供完善的监控、日志和错误追踪能力 (未来规划)。

### 2.2. 架构风格

本应用采用基于 **Clean Architecture (清晰架构)** 思想的 **模块化分层架构**，并成功实现了**依赖注入 (DI)** 和 **事件驱动** 的设计模式。这种架构强调关注点分离、依赖倒置原则，使得系统更加灵活、可测试和易于维护。

**核心原则:**

* **验证驱动设计:** 所有数据操作都经过严格验证。
* **缓存优先策略:** 多层缓存提升系统性能。
* **错误边界隔离:** 完善的错误处理和恢复机制。
* **依赖抽象化:** 面向接口编程，便于测试和扩展。
* **单一职责原则 (SRP)**
* **开放封闭原则 (OCP)**
* **里氏替换原则 (LSP)**
* **接口隔离原则 (ISP)**
* **依赖倒置原则 (DIP)**

### 2.3. 高层架构图

```mermaid
graph TD
    A[表现层 (UI - app/*)] --> B{应用层 (Services & Hooks - app/hooks/*, app/contexts/*)}
    B --> C{领域层 (Entities & Repository Interfaces - lib/models/*, lib/repositories/interfaces/*)}
    C --> D[数据层 (Repository Implementations & DAOs - lib/repositories/*, lib/database/*)]

    subgraph App_Layer [应用层]
        direction LR
        B
        B1[UI Hooks (e.g., useNewTaskService)]
        B2[Context Providers (e.g., NewAppProvider)]
        B3[Application Services (e.g., NewAppService)]
    end

    subgraph Domain_Layer [领域层]
        direction LR
        C
        C1[Domain Entities (lib/models/types.ts)]
        C2[Repository Interfaces (lib/repositories/interfaces/*)]
        C3[Domain Events (lib/events/*)]
    end

    subgraph Data_Infrastructure_Layer [数据层 / Infrastructure]
        direction LR
        D
        D1[SQLite DAOs (lib/database/*-dao.ts)]
        D2[Repository Implementations (lib/repositories/*Repository.ts)]
        D3[Database Manager (lib/database/manager.ts)]
        D4[Event Bus (lib/events/EventBus.ts)]
        D5[DI Container (lib/container/*)]
    end

    A --> B1
    A --> B2
    B1 --> B3
    B2 --> B3
    B3 --> C1
    B3 --> C2
    B3 --> D4 # Services publish events
    C2 --> D2 # Interfaces implemented by Repositories
    D2 --> D1 # Repositories use DAOs
    D1 --> D3 # DAOs use DatabaseManager

    classDef layer fill:#f9f,stroke:#333,stroke-width:2px;
    class A,B,C,D layer;
```

## 3. 分层架构详解

### 3.1. 表现层 (Presentation Layer) - `app/*`

职责:
负责所有用户界面的展示和用户交互。
捕获用户输入，并将其传递给应用层进行处理。
通过观察应用层（通常是自定义Hooks或Context）的数据变化来更新UI。
管理UI状态。
**已实施：** UI 组件 (`app/components/*`)，视图 (`app/(tabs)/*`, `app/task/*`, `app/note/*`)，使用 React Context API (`app/contexts/*`) 和自定义Hooks (`app/hooks/*`) 进行状态管理，使用 `expo-router` 管理导航，集成 Error Boundaries。

关键组件:
UI组件/小部件 (Widgets/Components): 位于 `app/components/*`，构建用户界面的基本元素。
视图 (Views/Screens): 应用的各个页面，位于 `app/(tabs)/*`, `app/task/*`, `app/note/*` 等。
状态管理: 使用 React Context API (`app/contexts/*`) 和自定义Hooks (`app/hooks/*`) 进行状态管理和与应用层的数据流。
导航控制器 (Navigation): 使用 `expo-router` 管理页面跳转。
错误边界 (Error Boundaries): React组件，捕获和处理UI层错误。

交互: 接收用户操作，调用应用层暴露的Hooks (如 `useNewTaskService`)；通过Context和Hooks获取数据以更新UI。

### 3.2. 应用层 (Application Layer) - `lib/services/*`, `app/hooks/*`, `app/contexts/*`

职责:
包含应用的具体用例，通过服务 (`NewTaskService`, `NewNoteService`) 实现，编排领域对象来完成特定任务。
作为表现层和领域层之间的桥梁，处理应用特有的逻辑。
定义数据传输对象 (DTOs) (`lib/models/types.ts` 中的一部分) 以适应表现层的需求。
提供应用入口服务 (`NewAppService`)，负责初始化和协调各服务。
**已实施：** `NewAppService.ts` 作为入口点，`NewTaskService.ts`, `NewNoteService.ts` 实现核心业务逻辑，`useNewTaskService`, `useNewNoteService` 等自定义Hooks 供UI调用，`NewAppProvider` 等 Context Provider 将服务注入 React 树，EventBus (`lib/events/EventBus.ts`) 用于服务解耦。

关键组件:
应用服务 (`NewAppService.ts`): 整个应用的入口点，负责初始化DI容器、数据库和所有核心服务。
领域特定服务 (`NewTaskService.ts`, `NewNoteService.ts`): 封装特定领域的业务逻辑，如任务管理、笔记管理。它们依赖Repository和EventBus。
自定义Hooks (`app/hooks/*`): 如 `useNewTaskService`，为UI层提供便捷的服务访问和状态管理。
Context Providers (`app/contexts/*`): 如 `NewAppProvider`，将新架构的服务注入到React组件树中。
事件总线 (`lib/events/EventBus.ts`): 用于服务间的解耦通信和发布领域事件。

交互: 接收来自表现层（通过Hooks）的请求，执行相应的服务方法；通过调用领域层定义的Repository接口来获取或持久化数据；将处理结果或数据模型返回给表现层；发布领域事件。

### 3.3. 领域层 (Domain Layer) - `lib/models/*`, `lib/repositories/interfaces/*`, `lib/events/*`

职责:
包含应用的核心业务逻辑、业务规则和领域实体。
这是应用中最稳定、最独立的部分。
定义Repository接口，这些接口规定了数据持久化和检索的契约，由数据层实现。
定义领域事件。
**已实施：** 领域实体 (`lib/models/types.ts`)，Repository 接口 (`lib/repositories/interfaces/*`)，领域事件 (`lib/events/*`)。

关键组件:
领域实体 (Entities): 在 `lib/models/types.ts` 中定义，代表核心业务概念 (e.g., `TaskDTO`, `NoteDTO`, `Project`)。
Repository 接口 (`lib/repositories/interfaces/*`): 定义了对领域实体进行CRUD操作以及其他数据查询操作的抽象接口 (e.g., `ITaskRepository`, `INoteRepository`).
领域事件 (`lib/events/TaskEvents.ts`, `NoteEvents.ts`): 定义业务状态变化时发布的事件。
值对象 (Value Objects): `lib/models/types.ts` 中的 `Priority`, `TaskStatus` 等。

交互: 提供领域实体和核心业务逻辑给应用层使用；定义数据操作的接口供数据层实现。

### 3.4. 数据层 (Data Layer / Infrastructure Layer) - `lib/database/*`, `lib/repositories/*`, `lib/container/*`

职责:
实现领域层定义的Repository接口，负责数据的持久化和检索。
与本地SQLite数据库进行交互。
封装所有与基础设施相关的技术细节，如数据库访问、依赖注入容器。
**已实施：** Repository 实现 (`lib/repositories/*Repository.ts`)，SQLite 数据库集成，DAOs (`lib/database/*-dao.ts`) 实现，`DatabaseManager` (`lib/database/manager.ts`)，Schema 定义 (`lib/database/schema.ts`)，DI 容器 (`lib/container/Container.ts`, `lib/container/ServiceRegistry.ts`)。

关键组件:
Repository 实现 (`lib/repositories/*Repository.ts`): 具体实现领域层定义的Repository接口 (e.g., `TaskRepository`, `NoteRepository`)。一个Repository协调一个或多个DAO。
本地数据源 (Local Data Source):
    SQLite 数据库: 通过DAO (`lib/database/*-dao.ts`) 与SQLite数据库进行交互，执行CRUD操作。
    数据库管理器 (`lib/database/manager.ts`): 负责数据库初始化、版本管理和迁移。
    Schema定义 (`lib/database/schema.ts`): 数据库表结构定义。
DI容器 (`lib/container/Container.ts`, `lib/container/ServiceRegistry.ts`): 负责服务的创建、依赖解析和生命周期管理。

交互: 实现领域层定义的Repository接口；与本地数据库交互来存取数据；被应用层的服务通过Repository接口调用。DI容器负责构建和提供服务实例。

## 4. 模块化设计

应用主要分为两大块：核心库 (`lib/`) 和应用UI (`app/`)，实现了清晰的模块边界。

### 4.1. 核心库 (`lib/`)

职责: 提供整个应用共享的基础组件、业务逻辑、数据访问和核心服务。这是应用的核心后端逻辑。**已完成架构和大部分实现。**

子模块/目录:

* `lib/container/`: 依赖注入容器。
* `lib/database/`: SQLite数据库访问层 (DAOs, Manager, Schema)。
* `lib/events/`: 事件总线和领域事件定义。
* `lib/models/`: 数据模型和类型定义 (DTOs, Entities, Value Objects)。
* `lib/repositories/`: Repository接口和实现。
* `lib/services/`: 应用服务和领域服务 (新架构的核心)。
* `lib/utils/`: 通用工具函数。

### 4.2. 应用模块 (`app/`)

职责: 包含所有用户界面、导航、特定于UI的Hooks和Context。这是应用的表现层。**已完成主要UI页面与新架构服务的集成。**

子模块/目录:

* `app/(tabs)/`:主要的标签页屏幕。
* `app/components/`: 可复用的UI组件。
* `app/contexts/`: React Context提供程序，用于将服务注入UI。
* `app/hooks/`: 自定义React Hooks，封装对应用服务的访问。
* `app/note/`, `app/task/`: 特定功能的屏幕，如创建/编辑任务或笔记。
* `app/_layout.tsx`, `app/index.tsx`: 应用的入口和根布局。

## 5. 数据管理

### 5.1. 本地数据存储

**数据库:** Expo SQLite (`expo-sqlite`)

**Schema 设计 (SQLite):**
与之前版本类似，核心表包括 `tasks`, `projects`, `notes`, `notebooks`, `tags`, `note_tags`。
关键字段: `id` (TEXT PRIMARY KEY, UUID), `created_at`, `updated_at`。
同步相关字段 (如 `sync_status`, `last_synced_at`, `local_version`, `remote_version_token`) 依然保留，为未来同步功能做准备。

**数据库管理 (`lib/database/manager.ts`):**
`DatabaseManager` 类负责：

* 初始化数据库连接。
* 执行表结构创建和必要的迁移。
* 提供对 `SQLiteDatabase` 实例的访问。

### 5.2. 数据访问对象 (DAO) - `lib/database/*-dao.ts`

**已实现：** `BaseDAO` 提供通用 CRUD，TaskDAO, NoteDAO, ProjectDAO 等实现特定查询。负责数据库行数据到领域实体/DTO的转换。

### 5.3. Repository模式 - `lib/repositories/*`

**已实现：** 接口 (`lib/repositories/interfaces/*`) 定义契约，实现 (`lib/repositories/*Repository.ts`) 依赖 DAO 执行数据操作，是应用服务访问数据的唯一入口。

## 6. 依赖注入与服务管理

新架构的核心是依赖注入 (DI) 和集中的服务管理。**DI容器和核心服务注册机制已完全实现并投入使用。**

### 6.1. 服务容器 (`lib/container/Container.ts`)

**已实现：** 一个简单的IoC容器，支持服务注册和解析，管理依赖和生命周期。

### 6.2. 服务注册 (`lib/container/ServiceRegistry.ts`)

**已实现：** `createContainer()` 工厂函数，集中注册所有核心服务 (DatabaseManager, DAOs, Repositories, EventBus, NewTaskService, NewNoteService, NewAppService) 及其依赖。

### 6.3. 应用服务 (`lib/services/NewAppService.ts`)

**已实现：** 作为新架构的中心协调器和访问入口，负责初始化 DI 容器和数据库，并通过容器管理其他服务。UI层通过 `useNewApp()` Hook 获取其实例。

## 7. 事件驱动机制

**事件总线 (`lib/events/EventBus.ts`) 已实现并用于服务间的解耦通信。**

### 7.2. 领域事件 (`lib/events/TaskEvents.ts`, `lib/events/NoteEvents.ts`)

**已定义并由相关 New*Service 发布。** 其他服务可以订阅以执行后续操作。

## 8. Expo + React Native实现

**技术栈选择:** Expo + React Native + TypeScript

**Expo框架优势:**

* 快速开发和部署。
* 丰富的内置API和第三方库支持。
* OTA (Over-The-Air) 更新能力。
* 简化的构建和发布流程。

**架构特点:**

* 使用Expo Router进行基于文件系统的路由导航。
* TypeScript提供类型安全和更好的开发体验。
* **新架构通过 `NewAppProvider` (`app/contexts/NewAppContext.tsx`) 和自定义Hooks (`app/hooks/*`) 集成到React组件中。**
  * `NewAppContext` 在应用启动时初始化 `NewAppService`。
  * 自定义Hooks (如 `useNewTaskService`) 从Context中获取服务实例，供UI组件调用。
* 旧的 `appService` 相关代码已大部分移除或标记为弃用。

## 9. 非功能性需求实现策略

### 9.1. 性能

* UI渲染: React Native优化最佳实践，FlatList虚拟化，`React.memo`, `useCallback`, `useMemo`。**已广泛应用于列表和组件中。**
* 数据操作: 优化SQLite查询 (索引，批量操作)。**在 DAO 层实现。**
* 后台任务: (未来规划) 将耗时操作（如同步）放到后台。
* 启动速度: `NewAppService.initializeApp()` 确保数据库等核心服务在应用启动时初始化。**已实现。**
* 应用层缓存: （未来规划）可以在服务层或Repository层添加缓存逻辑。

### 9.2. 安全性

* 本地数据: Expo SecureStore用于存储敏感信息。SQLite数据库本身未加密。
* 输入验证: 在服务层进行数据校验。

### 9.3. 可维护性与可扩展性

* 清晰分层与模块化: 新架构进一步加强了这一点。**已显著提升。**
* 依赖注入: `lib/container` 提供了DI容器，极大降低了耦合度。**已完全实现。**
* 事件驱动: `lib/events` 使得模块间可以松耦合通信。**已实现。**
* 接口驱动设计: Repository和Service层广泛使用接口。**已采用。**
* 代码规范与注释: 项目已遵循一定规范。

### 9.4. 监控与可观测性

* 目前主要依赖 `console.log` 进行调试。
* 未来可集成第三方错误追踪和性能监控服务。

## 10. 技术栈选型

**核心框架:**

* **跨平台框架:** Expo + React Native
* **开发语言:** TypeScript
* **路由导航:** Expo Router

**数据管理:**

* **本地数据库:** Expo SQLite (`expo-sqlite`)
* **DI容器:** 自定义实现 (`lib/container/Container.ts`)
* **状态管理 (UI):** React Context API +自定义 Hooks (`app/contexts/*`, `app/hooks/*`)

**UI/UX组件:**

* **基础组件:** React Native核心组件
* **图标:** `@expo/vector-icons`

**工具与开发:**

* **测试框架:** Jest (基本配置存在，待完善测试用例)
* **代码规范:** ESLint + Prettier

## 11. 未来展望与演进

* **数据同步:** 利用现有同步相关字段，实现与WebDAV、Google Drive等服务的同步。同步引擎和适配器将是核心。**需在新架构服务中实现具体同步逻辑。**
* **高级功能:** 日历视图、协作、附件支持。
* **测试覆盖:** 为新架构的服务、Repository、DAO编写更全面的单元测试和集成测试。
* **旧代码清理:** 在确认新架构稳定运行一段时间后，可以逐步移除所有标记为 `@deprecated` 的旧服务和相关代码。

## 12. 迁移总结

项目已成功从旧的单体服务架构迁移至基于依赖注入、Repository模式和事件驱动的新分层架构。**本次迁移是项目的重要里程碑，成功解决了原有的紧耦合问题，为未来的开发和扩展奠定了坚实基础。**

* **主要组件已迁移**: `app/_layout.tsx`, `app/(tabs)/index.tsx`, `app/task/create.tsx` 等核心UI组件已完全使用新架构服务驱动真实数据。
* **服务层重构完成**: `NewAppService` 作为应用入口，协调通过DI容器管理的新服务 (`NewTaskService`, `NewNoteService`)。
* **数据访问抽象完成**: Repository模式提供了清晰的数据访问接口，DAO 层负责与 SQLite 数据库交互。
* **依赖注入和事件驱动实现**: DI 容器和 EventBus 机制已完全实现并集成到新架构服务中。
* **旧代码状态**: 旧服务 (`appService`) 已标记为 `@deprecated`，但仍保留以确保平滑过渡，后续将逐步移除。
* **导入路径标准化**: 所有核心模块和组件的导入路径已统一使用 `@/` 别名。
详细的迁移过程和结果请参考 [架构重构完成指南.md](../../Docs/架构重构完成指南.md) 和 [迁移完成报告.md](../../Docs/迁移完成报告.md)。

---
此架构文档将随着项目的进展和需求的变化而持续更新。
