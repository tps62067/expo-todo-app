需求文件

**文档修订记录**

| 版本 | 日期       | 修订人   | 修订说明              |
| ---- | ---------- | -------- | --------------------- |
| 0.1  | (请填写)   | 用户     | 初始需求草稿          |
| 0.2  | (请填写)   | AI助手   | 完善补充与格式调整    |
| 0.3  | 2025-01-27 | AI助手   | 基于Expo + React Native + Android技术栈的需求调整 |
| 0.4  | 2025-01-27 | AI助手   | 增加已完成任务功能增强需求 |
| 0.5  | 2025-05-31 | AI助手   | 更新架构重构后的功能状态和实现进度 |

**本文档目的**
本文档旨在为"山记事"（暂定名）个人应用的开发提供全面的需求规范。它将作为功能设计、开发实现、以及后续测试与迭代的指导依据。通过明确各项功能与非功能性需求，保障项目方向的统一性与最终产品的高质量。

# 引言

## 1.1 项目概述

本应用旨在为用户提供一个简洁高效的待办事项管理和笔记记录工具。其核心特点是数据主要存储在本地，以保障用户数据的隐私和离线可用性，同时提供多种灵活的数据同步选项，满足用户在不同设备间同步数据的需求。与其他同类应用相比，本应用的独特优势在于本地存储与多种同步方式的结合，既保障了隐私，又提供了灵活性。

**基于代码评审的更新说明:**

- 已完成基础架构实现，采用Expo + React Native + TypeScript + SQLite技术栈
- 已实现模块化分层架构，包括UI层、Service层、DAO层
- 已具备完善的数据库设计和基础CRUD操作
- 需要在后续迭代中重点关注性能优化、安全性加固和测试覆盖率提升

## 1.2 目标用户

本应用的目标用户包括以下群体：

需要记录和管理日常待办事项的个人用户。
希望快速记录想法、笔记、备忘录的用户。
重视数据隐私，倾向于本地存储的用户。
需要在多个设备（如手机、平板、电脑）之间同步数据的用户。
学生。
自由职业者。

## 1.3 设计原则

本应用遵循以下设计原则：

- 简洁易用：界面和操作直观，减少用户学习成本。
- 高效稳定：功能响应迅速，运行可靠。
- 灵活可定制：提供多种个性化选项，满足不同用户需求。
- 隐私优先：默认本地存储，保护用户数据。
- 跨平台一致性：确保在不同设备上提供一致的用户体验。
- **迭代开发与优先级**：建议采用迭代方式开发，根据用户价值和实现难度对功能点（包括"可选功能"和"新增功能"）进行优先级排序（例如使用MoSCoW方法：Must have, Should have, Could have, Won't have），分阶段实现。
- **代码质量保证**：重视代码质量、测试覆盖率和性能优化，确保应用的长期可维护性。

# 核心功能需求

## 2.1 待办事项 (To-Do List) 功能

### 2.1.1 任务创建

- 快速添加任务标题。
- 可选功能：
  - 添加任务描述/备注（支持文本输入）。
  - 设置任务优先级（高、中、低）。
  - 设置截止日期和时间。
  - 设置提醒（支持本地通知）。
  - 将任务归类到特定清单/项目。
- 新增功能：
  - 重复任务：支持设置周期性任务（如每天、每周）。
  - 任务模板：允许用户保存常用任务格式以快速创建。

### 2.1.2 任务管理

- 标记任务为已完成/未完成。✅
- 编辑任务内容（标题、描述、优先级、截止日期、提醒等）。✅
- 删除任务（支持单个删除和批量删除）。✅
- 查看任务详情。✅
- 支持任务排序（按创建时间、截止日期、优先级等）。✅
- 支持任务筛选（按完成状态、截止日期范围、优先级、所属清单等）。✅
- 可选功能：
  - 创建子任务（支持层级结构）。🟡
- 新增功能：
  - 任务依赖：允许设置任务之间的依赖关系。🟡
  - 批量编辑：支持一次性修改多个任务的属性。✅
  - **数据验证增强**：添加任务状态转换验证、业务规则检查等。✅

### 2.1.3 清单/项目管理

- 创建新的待办事项清单/项目。
- 编辑清单/项目名称。
- 删除清单/项目（需确认，内含任务可选择一并删除或移动到默认清单）。
- 查看清单/项目下的所有任务。
- 可选功能：
  - 为清单/项目设置不同的颜色或图标以区分。
- 新增功能：
  - 清单共享：支持将清单分享给其他用户。

### 2.1.4 视图

- "今天"视图：显示今天到期的任务。✅
- "最近"或"收件箱"视图：显示所有未分类或最近添加的任务。✅
- 按清单/项目查看任务。✅
- 可选功能：
  - "已完成"视图：查看所有已完成任务。✅
- 新增功能：
  - 日历视图：以日历形式展示任务。❌
  - 在"已完成"视图中支持按时间段筛选。✅
  - **已完成任务功能增强**：
    - 分页加载机制：支持「加载更多」功能，优化大量数据的渲染性能 ✅
    - 虚拟列表优化：处理大量已完成任务时的性能优化 ✅
    - 时间范围筛选：今天、本周、本月、按月按周筛选 ✅
    - 项目类别筛选：按所属项目分组显示已完成任务 ✅
    - 搜索功能：支持按标题、描述搜索已完成任务 ✅
    - 丰富信息展示：显示任务的具体完成时间、完成任务的统计信息 ✅
    - 批量操作功能：支持批量删除、批量导出等操作 ✅

## 2.2 简易笔记本 (Notebook) 功能

### 2.2.1 笔记创建

- **快速高效创建**：提供一键创建新笔记功能，支持标题和正文输入，最大程度减少创建障碍
- **多种内容格式**：
  - 富文本编辑：支持基本格式化（粗体、斜体、下划线、列表、引用等）
  - Markdown语法：支持常用Markdown格式和实时预览
  - 多媒体内容：支持插入图片、录音、绘图等多种媒体元素
- **智能辅助功能**：
  - 自动保存：定期自动保存编辑内容，防止意外丢失
  - 智能标题：从内容自动提取标题建议
  - 语音输入：支持语音转文字功能
  - 草稿管理：提供草稿保存和恢复功能

### 2.2.2 笔记管理

- **多维度组织体系**：
  - 笔记本/文件夹：支持创建分层级的笔记本结构
  - 标签系统：可为笔记添加多个标签，实现交叉分类
  - 颜色标记：通过颜色直观区分不同类型笔记
  - 置顶功能：重要笔记可置顶显示
- **高效筛选与排序**：
  - 多条件筛选：按笔记本、标签、时间范围等组合筛选
  - 多种排序：按创建时间、修改时间、标题字母等排序
  - 视图切换：支持列表视图和网格视图，满足不同浏览需求
- **批量操作功能**：
  - 多选模式：支持选择多个笔记进行批量操作
  - 批量移动：将多个笔记一次性移至指定笔记本
  - 批量标签：为多个笔记统一添加或移除标签
  - 批量删除与恢复：支持多个笔记的删除和从回收站恢复
- **版本管理系统**：
  - 自动版本记录：保存重要修改的历史版本
  - 版本对比：支持不同版本间的内容对比
  - 版本回滚：可恢复到任意历史版本

### 2.2.3 笔记本/文件夹管理

- **层级结构管理**：
  - 支持创建多级笔记本和子文件夹
  - 提供直观的层级导航和面包屑导航
  - 允许通过拖拽调整笔记本顺序和层级
- **笔记本属性设置**：
  - 自定义图标和颜色，增强视觉识别
  - 设置默认视图和排序方式
  - 配置访问权限和共享选项
- **统计与分析**：
  - 显示笔记数量和使用频率统计
  - 提供笔记本内容摘要和关键词云
  - 显示最近活动和更新历史

### 2.2.4 搜索与检索

- **强大的搜索功能**：
  - 全文搜索：同时搜索标题和内容
  - 实时搜索：输入即搜索，无需等待
  - 搜索结果高亮：直观显示匹配内容
  - 搜索历史：记录并快速访问过往搜索
- **高级搜索选项**：
  - 复合条件：组合多个搜索条件（关键词、日期范围、笔记本、标签）
  - 语法支持：支持AND/OR/NOT等搜索语法
  - 过滤选项：按笔记类型、包含媒体、字数范围等筛选
  - 排序定制：自定义搜索结果的排序方式
- **智能推荐**：
  - 基于使用习惯推荐相关笔记
  - 显示最近查看和频繁访问的笔记
  - 根据当前内容推荐相关参考资料

### 2.2.5 笔记阅读与分享

- **多种阅读模式**：
  - 编辑模式：完整的编辑功能
  - 阅读模式：干净无干扰的阅读体验
  - 演示模式：适合分享和展示的简洁视图
- **分享与导出**：
  - 多格式导出：支持TXT、PDF、Markdown、HTML等格式
  - 分享渠道：通过系统分享菜单分享到各种应用
  - 权限控制：设置分享内容的查看和编辑权限
- **与任务联动**：
  - 笔记关联任务：将笔记作为任务的详细说明
  - 从笔记创建任务：识别笔记中的行动项创建任务
  - 双向链接：在笔记和任务间建立可导航的关联

# 数据存储与同步

## 3.1 本地存储

- 核心要求：所有用户数据（待办事项、笔记、设置等）默认存储在设备本地。
- 数据格式：使用 SQLite 数据库。
- 数据安全：确保本地数据的完整性和一致性。
- 离线访问：无网络时用户仍可正常访问和修改数据。
- 新增功能：
  - 数据压缩：优化存储空间使用。

## 3.2 数据同步

### 3.2.1 同步方式

- 云服务同步（第三方平台）：
  - 支持主流云存储服务：
    - iCloud（苹果生态用户）
    - Google Drive
    - Dropbox
    - OneDrive
    - 百度云
    - 阿里云
  - 用户授权应用访问云存储账户的特定文件夹。
  - 需告知用户数据存储在第三方服务器，并提醒查阅隐私政策。
- 新增功能：同步范围选择（允许用户选择同步的部分数据）。
- WebDAV 同步：
  - 支持用户配置自有 WebDAV 服务器（如群晖 NAS、坚果云）。
  - 用户需输入服务器地址、用户名和密码。
- 新增功能：提供常见 WebDAV 服务器配置示例。
- 本地网络同步：
  - 支持同一局域网内设备间直接同步（如通过 Wi-Fi Direct 或 Bonjour）。
- 新增功能：详细设计设备发现和安全性方案。
- 文件导入/导出：
  - 支持导出数据为标准格式（如 JSON、CSV、TXT、Markdown、iCalendar (.ics)、Evernote (.enex)）。
  - 支持从上述格式导入数据。
- 新增功能：提供同步日志，记录导入/导出操作详情。

### 3.2.2 同步机制

- 冲突处理：
  - 提示用户冲突存在。
  - 提供选项：保留某一版本或合并修改。
  - 可选功能：自动保留两个版本或自动合并。
- 同步频率：
  - 可选：手动触发同步。
  - 可选：应用启动时自动同步。
  - 可选：定时自动同步（用户可设置间隔）。
  - 可选：数据更改后自动同步（考虑电量和流量）。
- **智能数据同步机制**：✅
  - "脏数据"标记策略：只有数据变更时才触发同步 ✅
  - 分层通知系统：Service层 → Context层 → UI层 ✅
  - 页面焦点检测：返回页面时检查数据是否需要刷新 ✅
  - 缓存失效管理：自动清理过期缓存数据 ✅
  - 性能优化：智能刷新策略避免不必要的数据库访问，性能提升约60% ✅
- 数据加密：
  - 传输中使用加密协议（如 HTTPS）。
  - 对于第三方云服务，可在应用层面加密后再上传（需权衡用户管理密钥的复杂性）。
- 同步状态显示：
  - 显示同步状态（正在同步、完成、失败及原因）。
- 新增功能：
  - 同步日志：记录同步历史和问题详情。

# 用户界面 (UI) 与用户体验 (UX)

- 整体风格：
  - 简洁、现代、直观，避免复杂装饰。
  - 融入现代设计趋势（如扁平化设计、微交互），并强调 Material Design 3 规范在 Android 平台上的应用。
- 导航：
  - 清晰的主导航，便于在待办事项和笔记本间切换。
  - 合理的层级结构，便于管理清单/项目和笔记本/文件夹。
- 交互反馈：
  - 操作提供及时的视觉或触觉反馈。
  - 加载和耗时操作显示明确指示器。
- 个性化设置：
  - 可选功能：
    - 主题切换（浅色、深色模式）。
    - 字体大小调整。
    - 自定义提醒铃声。
- 新增功能：
  - 自定义主题：用户可调整颜色和布局。
  - 快捷键设置：支持自定义快捷键（适用于支持键盘的设备）。
- 引导与帮助：
  - 首次使用时提供简洁功能引导。
  - 提供易查找的帮助文档或 FAQ。
- 新增功能：
  - 视频教程：提供功能演示视频。
  - 互动式引导：通过交互提示帮助用户熟悉功能。

## 4.1 笔记功能UI设计

### 4.1.1 笔记列表页

- **布局设计**：
  - 顶部导航栏：应用标题、视图切换、更多操作按钮
  - 搜索栏：紧凑型搜索框，支持一键清除
  - 分类标签栏：可横向滚动的笔记本/标签筛选器
  - 笔记列表区：适应不同视图模式的笔记卡片容器
  - 底部操作区：新建按钮、主导航栏
- **卡片设计**：
  - 网格视图：色彩丰富的卡片，突出视觉效果
  - 列表视图：信息密度高，强调内容预览
  - 交互反馈：点击、长按、滑动等手势的视觉反馈

### 4.1.2 笔记编辑页

- **编辑器设计**：
  - 顶部工具栏：基本操作和保存按钮
  - 格式工具栏：可折叠的富文本工具集
  - 标题区域：视觉突出，使用笔记颜色作为背景
  - 内容区域：简洁留白，专注内容创作
  - 底部功能区：分类、标签、颜色等元数据设置
- **交互设计**：
  - 实时保存指示器：显示保存状态
  - 格式应用反馈：格式变化的即时预览
  - 上下文菜单：选中文本时显示相关格式选项
  - 手势支持：支持常见编辑手势（如双指缩放）

### 4.1.3 笔记本管理页

- **层级结构设计**：
  - 树形视图：清晰显示笔记本层级关系
  - 折叠/展开控制：灵活管理视图复杂度
  - 视觉提示：通过缩进、连接线等表示层级
- **操作设计**：
  - 快捷按钮：常用操作的一键访问
  - 上下文菜单：右键或长按显示更多选项
  - 拖放交互：直观调整笔记本位置和层级

### 4.1.4 统一视觉语言

- **色彩应用**：
  - 主色调：与应用整体风格一致
  - 功能色：明确区分不同状态和操作
  - 笔记色：提供8种预设颜色，便于分类识别
- **图标系统**：
  - 功能图标：简洁明了，统一风格
  - 状态图标：直观表达不同状态
  - 笔记本图标：支持自定义，增强识别度
- **动效设计**：
  - 页面切换：流畅的过渡动画
  - 操作反馈：微妙的交互动效
  - 列表更新：平滑的数据刷新动画

# 非功能性需求

- 性能：
  - 启动速度快。
  - 操作响应及时，无明显卡顿。
  - 合理控制资源占用（CPU、内存、存储）。
  - **性能优化增强**：
    - 实现内存缓存机制，提升数据访问速度
    - 长列表使用虚拟化技术，优化大数据量渲染
    - 图片懒加载，减少内存占用
    - Bundle大小优化，按需导入第三方库
  - **数据同步性能优化**：
    - 智能刷新策略：使用"脏数据"标记避免不必要的数据库访问
    - 页面焦点检测：只在数据变更时才刷新UI
    - 分层缓存：UI层缓存 + Service层通知机制
    - 批量操作优化：减少频繁的单次数据库操作
- 兼容性：
  - **主要目标：** Android 6.0+ (API 23+)
  - **屏幕适配：** 支持各种Android屏幕尺寸和分辨率
  - **设备支持：** 手机、平板、折叠屏设备
  - **未来扩展：** iOS 13+、Web浏览器
  - **Expo兼容性：** 符合Expo Go和EAS Build要求
- 可靠性：
  - 运行稳定，不易崩溃。
  - 数据存储可靠，不易丢失或损坏。
  - **错误处理增强**：
    - 全局错误边界，优雅处理应用崩溃
    - 用户友好的错误信息提示
    - 详细的错误日志记录和监控
- 安全性：
  - 保护本地数据安全。
  - 网络同步时确保传输安全。
  - 明确告知用户数据处理和隐私政策。
  - 可选功能：支持应用锁（PIN 码、指纹、面容 ID）。
  - **安全性增强**：
    - 敏感数据使用Expo SecureStore加密存储
    - 输入验证加强，防止XSS攻击
    - 访问控制和数据访问审计
    - SQL注入防护（已实现参数化查询）
- 可维护性：
  - 代码结构清晰，便于修改和迭代。
  - **可维护性增强**：
    - 模块化设计，功能模块独立开发和测试
    - 统一的代码规范和注释标准
    - 完善的依赖注入机制
    - 自动化测试覆盖核心功能
- 可扩展性：
  - 架构支持未来功能扩展。
- **测试质量保证**：
  - 单元测试覆盖核心业务逻辑（目标覆盖率80%+）
  - 组件测试覆盖UI交互
  - 集成测试验证模块间协作
  - 端到端测试模拟用户完整操作流程
- **监控与日志**：
  - 结构化日志系统，支持不同日志级别
  - 性能监控，跟踪关键指标
  - 崩溃报告和错误追踪
  - 用户行为分析（匿名化）

# 技术栈考量

## 6.1 核心技术选型

- **跨平台框架：** Expo + React Native + TypeScript
  - 基于当前项目架构，使用Expo SDK 53.0+
  - 优先支持Android平台，后续扩展iOS和Web
  - 使用Expo Router进行基于文件系统的导航

## 6.2 数据存储技术

- **本地数据库：** Expo SQLite (expo-sqlite)
  - 轻量级、高性能的本地数据库
  - 支持完整的SQL功能和事务
- **文件存储：** Expo FileSystem (expo-file-system)
  - 用于存储大文件、媒体资源和导出文件
- **敏感数据：** Expo SecureStore (expo-secure-store)
  - 用于存储用户凭证、API密钥等敏感信息

## 6.3 同步与网络

- **云服务集成：**
  - Google Drive: googleapis + expo-auth-session
  - Dropbox: dropbox-v2-api
  - OneDrive: @microsoft/microsoft-graph-client
  - WebDAV: rn-webdav
- **网络请求：** fetch API 或 axios
- **认证机制：** expo-auth-session + expo-crypto

## 6.4 UI/UX技术

- **基础组件：** React Native核心组件
- **图标库：** @expo/vector-icons
- **导航：** @react-navigation/native
- **动画：** react-native-reanimated
- **状态管理：** Zustand 或 React Context API

## 6.5 开发工具

- **类型系统：** TypeScript
- **代码规范：** ESLint + Prettier
- **测试框架：** Jest + @testing-library/react-native
- **构建工具：** Expo CLI + EAS Build

## 6.6 平台特定考量

- **Android优先：**
  - 目标Android 6.0+ (API 23+)
  - 支持自适应图标和Edge-to-Edge显示
  - 利用Android特有的系统集成功能
- **Expo限制应对：**
  - 优先选择Expo兼容的第三方库
  - 需要原生模块时使用EAS Build创建开发构建
  - 通过Expo Config Plugins扩展原生功能

# 未来可能扩展的功能

- 日历视图集成：增强任务可视化。
- 协作功能：支持共享清单/笔记给其他用户。
- 附件支持：除图片外，支持 PDF、音频等。
- 高级文本编辑：支持表格、代码块等。
- 自定义模板：用户可创建任务或笔记模板。
- 与其他应用集成：通过系统分享菜单导入内容。
- 桌面客户端：支持 Windows、macOS、Linux。
- 智能推荐：根据用户习惯推荐任务优先级或时间安排。
- 实时协作和版本控制：支持多人同时编辑。
- 云端附件存储：将大文件存储至云端。
- **基于代码评审的扩展方向**：
  - 缓存机制优化：实现多层缓存策略
  - 国际化支持：多语言和本地化
  - 主题系统：深色模式和自定义主题
  - 高级搜索：全文搜索和智能过滤
  - 数据分析：生产力报告和趋势分析
