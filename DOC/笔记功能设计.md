# 笔记功能设计文档

## 1. 产品需求分析

### 1.1 功能定位与目标

笔记模块是"山记事"应用的第二核心功能，与待办事项功能相辅相成，提供一个简洁高效的信息记录与管理工具。

**核心目标**：
- 提供直观便捷的信息记录方式
- 支持丰富的内容表达形式
- 建立灵活高效的笔记组织体系
- 确保笔记数据的安全与隐私

**目标用户**：
- 需要快速记录灵感与想法的创意工作者
- 需要整理学习笔记的学生
- 习惯记录生活点滴的个人用户
- 需要管理工作信息的专业人士

### 1.2 功能需求详细说明

#### 1.2.1 笔记创建

**基础功能**：
- 快速创建笔记，支持标题和正文输入
- 支持笔记分类，可归属到不同笔记本
- 支持添加多个标签进行多维归类
- 支持设置笔记颜色，提供视觉区分

**内容格式**：
- 富文本编辑功能：提供基础格式化工具（粗体、斜体、下划线、列表、引用等）
- Markdown支持：提供常用Markdown语法支持和实时预览
- 多媒体支持：允许插入图片、录音、简单绘图

**智能辅助**：
- 自动保存草稿，防止意外丢失内容
- 自动提取标题（从首行或内容关键句）
- 语音输入转文字功能
- 智能标签推荐

#### 1.2.2 笔记管理

**组织功能**：
- 笔记本/文件夹系统：支持创建、编辑、删除笔记本
- 嵌套结构：支持笔记本内创建子文件夹，构建层级结构
- 标签系统：灵活添加多个标签，支持按标签筛选
- 置顶功能：重要笔记可置顶显示

**筛选与排序**：
- 多维度筛选：按笔记本、标签、创建时间、修改时间
- 多种排序方式：按标题、创建时间、修改时间、颜色等
- 视图切换：列表视图/网格视图/大纲视图
- 归档功能：将不常用笔记归档，减少主视图干扰

**批量操作**：
- 批量选择：支持多选模式
- 批量移动：将多个笔记移至指定笔记本
- 批量标签：为多个笔记添加相同标签
- 批量删除和恢复：支持删除和从回收站恢复

**版本管理**：
- 自动版本历史：记录重要修改
- 版本对比：查看不同版本间差异
- 版本回滚：恢复到之前版本

#### 1.2.3 笔记查看与检索

**查看模式**：
- 编辑模式：完整的编辑功能
- 阅读模式：干净无干扰的阅读体验
- 演示模式：适合分享和展示的简洁视图

**搜索功能**：
- 全文搜索：同时搜索标题和内容
- 实时搜索：输入即搜索，无需等待
- 搜索结果高亮：直观显示匹配内容
- 高级搜索：支持按时间范围、笔记本、标签等条件组合搜索

**分享与导出**：
- 支持多种格式导出：TXT、PDF、Markdown、HTML
- 分享单条笔记：通过系统分享菜单
- 分享笔记本：导出整个笔记本的内容
- 与任务关联：笔记可关联到特定任务

### 1.3 与待办任务的联动

- 任务附注：待办任务可关联到特定笔记作为详细说明
- 笔记转任务：从笔记内容一键创建相关任务
- 双向链接：任务和笔记间建立可导航的关联
- 同步更新：关联内容变更时提供更新提醒

## 2. UI设计规范

### 2.1 设计原则

- **一致性**：与应用整体风格保持一致，特别是与任务管理模块
- **简洁性**：界面简洁明了，突出内容本身
- **层次感**：通过颜色、间距和排版建立清晰的视觉层次
- **可发现性**：重要功能易于发现，避免深层嵌套
- **响应性**：所有操作提供及时反馈，确保用户感知操作结果

### 2.2 关键界面设计

#### 2.2.1 笔记列表页

**布局结构**：
- 顶部导航栏：标题、视图切换、更多操作
- 搜索栏：支持快速搜索
- 分类标签栏：可横向滚动的笔记本/标签筛选
- 笔记列表/网格：显示笔记卡片
- 底部操作区：新建按钮、导航栏

**笔记卡片设计**：
- 网格视图：
  - 显示标题（最多2行）
  - 内容预览（最多4行）
  - 底部显示日期和分类
  - 背景使用笔记设定的颜色
- 列表视图：
  - 左侧色彩标识
  - 右侧显示标题、预览内容、元数据
  - 紧凑排列，一屏显示更多内容

**交互行为**：
- 点击笔记卡片：进入笔记详情
- 长按笔记卡片：触发选择模式
- 左右滑动：快速操作（归档/删除）
- 下拉刷新：更新笔记列表

#### 2.2.2 笔记编辑页

**布局结构**：
- 顶部导航：关闭按钮、页面标题、格式工具切换、保存按钮
- 格式工具栏：可展开/收起的格式化工具集
- 标题区域：突出显示，可使用笔记颜色作为背景
- 内容编辑区：大面积留白，专注内容创作
- 元数据区域：分类、颜色、标签等设置项

**编辑器设计**：
- 富文本模式：
  - 底部固定工具栏，显示常用格式化选项
  - 选中文本显示上下文格式工具
  - 支持图片插入和简单编辑
- Markdown模式：
  - 支持语法高亮
  - 可选分屏预览
  - 快捷工具插入Markdown语法

**交互行为**：
- 实时保存：编辑过程中自动保存
- 撤销/重做：支持多级操作历史
- 智能格式识别：自动识别列表、链接等格式

#### 2.2.3 笔记本管理页

**布局结构**：
- 列表视图：显示所有笔记本及其层级结构
- 每项包含：图标、名称、笔记数量、操作菜单
- 支持拖拽调整顺序和层级

**交互行为**：
- 点击笔记本：显示该笔记本中的所有笔记
- 长按：触发拖拽排序模式
- 滑动：显示快捷操作（编辑/删除）

### 2.3 色彩与排版

**色彩系统**：
- 主色调：与应用整体一致（COLORS.primary）
- 笔记颜色：提供8种预设颜色（已在代码中定义）
- 状态色：
  - 普通：COLORS.gray100 ~ COLORS.gray700
  - 强调：COLORS.primary
  - 警告：COLORS.warning
  - 危险：COLORS.danger

**排版规范**：
- 笔记标题：20sp, 粗体(600)
- 笔记内容：16sp, 常规字重, 行高24sp
- 分类标签：14sp, 中等字重(500)
- 元数据文本：12sp, 常规字重
- 按钮文字：16sp, 中等字重(600)

**间距与尺寸**：
- 卡片内边距：16px
- 元素间距：8px (小), 16px (中), 24px (大)
- 圆角：8px (小), 12px (中), 20px (大/圆形)
- 图标尺寸：16px (小), 20px (中), 24px (大)

## 3. 技术实现规划

### 3.1 架构设计

遵循应用已有的分层架构设计模式：

**展示层 (UI)**：
- `app/note/`目录：笔记相关页面
- `app/components/note/`目录：笔记相关组件

**服务层 (Service)**：
- `lib/services/NewNoteService.ts`：笔记业务逻辑
- `lib/services/NewNotebookService.ts`：笔记本业务逻辑

**数据访问层 (Repository)**：
- `lib/repositories/NoteRepository.ts`：笔记仓库
- `lib/repositories/NotebookRepository.ts`：笔记本仓库

**数据访问对象层 (DAO)**：
- `lib/database/note-dao.ts`：笔记数据访问
- `lib/database/notebook-dao.ts`：笔记本数据访问
- `lib/database/note-version-dao.ts`：笔记版本数据访问

**事件与通知**：
- `lib/events/NoteEvents.ts`：笔记相关事件定义
- `lib/events/EventBus.ts`：事件总线，连接各层

### 3.2 组件设计

#### 核心组件

1. **NoteEditor**：
   - 富文本编辑器组件
   - 支持格式化工具栏
   - 处理文本选择和格式应用
   - 管理图片插入和排版

2. **MarkdownEditor**：
   - Markdown语法编辑组件
   - 支持语法高亮
   - 集成预览功能
   - 提供快捷工具栏

3. **NoteCardList**：
   - 笔记卡片列表组件
   - 支持列表/网格视图切换
   - 实现虚拟化列表优化性能
   - 处理卡片交互事件

4. **NoteFilters**：
   - 笔记筛选组件
   - 提供多维度筛选控件
   - 管理筛选状态
   - 与列表组件联动

5. **TagManager**：
   - 标签管理组件
   - 展示现有标签
   - 支持添加/删除标签
   - 提供标签建议

#### 页面组件

1. **NotesListScreen** (`app/(tabs)/notes.tsx`)：
   - 笔记列表主页面
   - 集成筛选和搜索功能
   - 管理笔记数据加载
   - 处理列表交互

2. **NoteEditorScreen** (`app/note/edit.tsx`)：
   - 笔记编辑页面
   - 集成编辑器组件
   - 管理笔记保存逻辑
   - 处理元数据设置

3. **NoteDetailScreen** (`app/note/[id].tsx`)：
   - 笔记详情页面
   - 提供阅读视图
   - 支持分享和导出
   - 管理版本历史访问

4. **NotebookManagementScreen** (`app/note/notebooks.tsx`)：
   - 笔记本管理页面
   - 显示笔记本层级结构
   - 支持笔记本的CRUD操作
   - 实现拖拽排序功能

### 3.3 数据模型

#### 主要实体

已有的数据模型基本满足需求，可能需要的调整：

1. **Note实体**：
   - 新增`view_count`：访问计数
   - 优化`content`存储：考虑JSON或特定格式存储富文本
   - 新增`plain_content`：存储纯文本版本用于搜索

2. **Notebook实体**：
   - 完善层级结构：`parent_id`关联
   - 新增`display_order`：显示顺序
   - 新增`default_color`：默认笔记颜色

3. **NoteVersion实体**：
   - 新增`change_type`：变更类型
   - 新增`summary`：变更摘要

4. **新增NoteMedia实体**：
   - `id`：唯一标识
   - `note_id`：关联笔记
   - `type`：媒体类型（图片/音频/绘图）
   - `local_uri`：本地存储路径
   - `remote_url`：远程存储URL
   - `width`/`height`：尺寸信息
   - `create_at`/`updated_at`：时间戳

5. **新增NoteTaskRelation实体**：
   - `note_id`：笔记ID
   - `task_id`：任务ID
   - `relation_type`：关联类型
   - `created_at`：创建时间

### 3.4 关键业务逻辑

1. **富文本处理**：
   - 实现基本格式化操作（粗体、斜体、列表等）
   - 处理文本选择和格式应用
   - 设计富文本存储结构
   - 实现富文本到纯文本的转换

2. **笔记版本管理**：
   - 确定版本保存策略（定时/重要变更）
   - 设计版本差异计算算法
   - 实现版本回滚逻辑

3. **笔记本层级管理**：
   - 实现嵌套结构的存储和查询
   - 设计层级显示和导航逻辑
   - 处理笔记本移动和合并

4. **搜索与筛选优化**：
   - 实现高效的全文搜索
   - 设计多条件筛选逻辑
   - 优化大量数据的检索性能

5. **数据同步策略**：
   - 设计笔记特有的同步规则
   - 处理富文本内容的冲突合并
   - 管理多媒体资源的同步

## 4. 数据库设计

### 4.1 表结构调整

基于现有数据库设计和对笔记功能更细致的考虑，需要进行以下调整和新增：

1. **notes表**
   - **现有重要字段保留**：如 `id`, `title`, `content`, `content_type`, `is_draft`, `created_at`, `updated_at`, `notebook_id`, 以及用于同步和软删除的 `sync_status`, `last_synced_at`, `local_version`, `remote_version_token`, `is_deleted_locally` 字段将保留。
   - **新增/修改字段**：
```sql
ALTER TABLE notes
ADD COLUMN color TEXT, -- 用于存储笔记自身的颜色
ADD COLUMN is_pinned INTEGER DEFAULT 0,
ADD COLUMN is_archived INTEGER DEFAULT 0,
ADD COLUMN view_count INTEGER DEFAULT 0,
ADD COLUMN plain_content TEXT, -- 用于全文搜索的纯文本内容
ADD COLUMN last_viewed_at TEXT; -- 上次查看时间
```
   - **说明**：`color` 字段允许笔记独立于笔记本设置颜色。`is_pinned` 和 `is_archived` 支持笔记的置顶和归档功能。`view_count`, `plain_content`, `last_viewed_at` 为新增功能支持。

2. **note_versions表**
   - 此表用于记录笔记的版本历史，建议采用更详细的结构：
```sql
CREATE TABLE IF NOT EXISTS note_versions (
  id TEXT PRIMARY KEY,
  note_id TEXT NOT NULL,
  version_number INTEGER NOT NULL,
  title TEXT,             -- 版本对应的标题
  content TEXT,           -- 版本对应的富文本内容
  plain_content TEXT,     -- 版本对应的纯文本内容
  change_type TEXT,       -- 变更类型 (如: 'created', 'updated', 'content_changed', 'metadata_changed')
  change_summary TEXT,    -- 变更摘要
  created_at TEXT NOT NULL,
  FOREIGN KEY (note_id) REFERENCES notes (id) ON DELETE CASCADE
);
```

3. **note_media表 (新增)**
   - 用于存储笔记中的多媒体附件信息。
```sql
CREATE TABLE IF NOT EXISTS note_media (
  id TEXT PRIMARY KEY,
  note_id TEXT NOT NULL,
  media_type TEXT NOT NULL CHECK(media_type IN ('image', 'audio', 'drawing')), -- 媒体类型
  local_uri TEXT,         -- 本地存储路径
  remote_url TEXT,        -- 远程存储URL (同步后)
  thumbnail_uri TEXT,     -- 缩略图路径 (可选)
  width INTEGER,          -- 宽度 (针对图片/绘图)
  height INTEGER,         -- 高度 (针对图片/绘图)
  size_bytes INTEGER,     -- 文件大小
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  sync_status INTEGER DEFAULT 0,
  is_deleted_locally INTEGER DEFAULT 0,
  FOREIGN KEY (note_id) REFERENCES notes (id) ON DELETE CASCADE
);
```

4. **note_task_relations表 (新增)**
   - 用于建立笔记与任务之间的关联。
```sql
CREATE TABLE IF NOT EXISTS note_task_relations (
  note_id TEXT NOT NULL,
  task_id TEXT NOT NULL,
  relation_type TEXT NOT NULL CHECK(relation_type IN ('linked_to', 'created_from_note', 'note_for_task')), -- 关联类型
  created_at TEXT NOT NULL,
  PRIMARY KEY (note_id, task_id),
  FOREIGN KEY (note_id) REFERENCES notes (id) ON DELETE CASCADE,
  FOREIGN KEY (task_id) REFERENCES tasks (id) ON DELETE CASCADE
);
```

### 4.2 索引优化

为提高查询性能，结合上述表结构调整和新增，建议配置以下索引（部分已在 `schema.ts` 中存在，此处为汇总和补充）：

```sql
-- notes表相关索引
CREATE INDEX IF NOT EXISTS idx_notes_notebook_id ON notes (notebook_id);
CREATE INDEX IF NOT EXISTS idx_notes_is_pinned ON notes (is_pinned);
CREATE INDEX IF NOT EXISTS idx_notes_is_archived ON notes (is_archived);
CREATE INDEX IF NOT EXISTS idx_notes_updated_at ON notes (updated_at DESC); -- 优化按更新时间排序
CREATE INDEX IF NOT EXISTS idx_notes_plain_content ON notes (plain_content) WHERE plain_content IS NOT NULL; -- 全文搜索优化
-- 现有 schema.ts 中的相关索引也应保留或根据需要调整，如：
-- CREATE INDEX IF NOT EXISTS idx_note_search ON notes(title, content); -- 可评估是否被 plain_content 索引替代或共存
-- CREATE INDEX IF NOT EXISTS idx_note_is_draft ON notes(is_draft);
-- CREATE INDEX IF NOT EXISTS idx_note_sync_status ON notes(sync_status);
-- CREATE INDEX IF NOT EXISTS idx_note_is_deleted_locally ON notes(is_deleted_locally);

-- note_versions表相关索引
CREATE INDEX IF NOT EXISTS idx_note_versions_note_id ON note_versions (note_id);
CREATE INDEX IF NOT EXISTS idx_note_versions_note_id_version_number ON note_versions (note_id, version_number DESC);

-- note_media表相关索引
CREATE INDEX IF NOT EXISTS idx_note_media_note_id ON note_media (note_id);
CREATE INDEX IF NOT EXISTS idx_note_media_media_type ON note_media (media_type);

-- note_task_relations表相关索引
CREATE INDEX IF NOT EXISTS idx_note_task_relations_note_id ON note_task_relations (note_id);
CREATE INDEX IF NOT EXISTS idx_note_task_relations_task_id ON note_task_relations (task_id);

-- 笔记本索引 (notebooks 表，保持不变，仅作参考)
-- CREATE INDEX IF NOT EXISTS idx_notebook_name ON notebooks(name);
-- ... (其他 notebooks 表的索引)

-- 标签关联索引 (note_tags 表，保持不变，仅作参考)
-- CREATE INDEX IF NOT EXISTS idx_note_tags_note_id ON note_tags (note_id);
-- CREATE INDEX IF NOT EXISTS idx_note_tags_tag_id ON note_tags (tag_id);
```

## 5. 实现计划

### 5.1 阶段划分

#### 阶段一：基础功能实现（2周）

1. **笔记创建与编辑基础功能**
   - 迁移现有代码到新架构
   - 完成笔记创建表单和数据库操作
   - 实现基本的富文本编辑功能
   - 开发笔记详情页面

2. **笔记列表与查看功能**
   - 完善笔记列表页
   - 实现列表/网格视图切换
   - 添加基础搜索和筛选功能
   - 实现笔记删除和恢复功能

#### 阶段二：高级编辑与组织功能（2周）

1. **富文本编辑增强**
   - 完善格式化工具
   - 添加链接支持
   - 实现列表和引用块
   - 开发图片插入功能

2. **笔记本与标签管理**
   - 实现笔记本CRUD功能
   - 开发笔记本层级结构
   - 完善标签系统
   - 实现笔记在笔记本间移动

#### 阶段三：高级功能与优化（2周）

1. **版本历史与同步**
   - 实现版本记录功能
   - 开发版本对比和回滚界面
   - 设计并实现笔记同步策略
   - 优化冲突处理机制

2. **性能优化与用户体验提升**
   - 实现笔记列表虚拟化
   - 优化富文本编辑性能
   - 增强搜索功能性能
   - 添加动画和过渡效果

### 5.2 具体任务分解

#### 阶段一核心任务

1. **创建笔记详情页面**
   - 新建`app/note/[id].tsx`文件
   - 实现笔记详情加载
   - 添加编辑和删除功能
   - 设计阅读模式界面

2. **完善笔记创建页面**
   - 迁移`app/note/create.tsx`到新架构
   - 连接到`NewNoteService`
   - 实现表单验证
   - 添加自动保存功能

3. **增强笔记列表页面**
   - 改进`app/(tabs)/notes.tsx`
   - 实现真实数据筛选和排序
   - 优化列表性能
   - 添加卡片交互功能

4. **富文本编辑器组件**
   - 创建`app/components/note/NoteEditor.tsx`
   - 实现基础格式化功能
   - 设计格式工具栏
   - 处理文本选择和格式应用

#### 阶段二核心任务

1. **笔记本管理页面**
   - 创建`app/note/notebooks.tsx`
   - 实现笔记本列表显示
   - 添加创建和编辑功能
   - 设计层级结构界面

2. **标签管理系统**
   - 创建`app/components/note/TagManager.tsx`
   - 实现标签添加和删除
   - 设计标签筛选功能
   - 开发标签云组件

3. **图片处理功能**
   - 创建`app/components/note/ImagePicker.tsx`
   - 实现图片选择和拍照
   - 添加基础图片编辑
   - 设计图片在笔记中的排版

4. **批量操作功能**
   - 创建`app/components/note/BatchOperationBar.tsx`
   - 实现多选模式
   - 添加批量操作按钮
   - 处理批量移动和删除逻辑

### 5.3 优先级与里程碑

#### 优先级排序

1. **最高优先级（必须实现）**
   - 笔记创建与编辑基础功能
   - 笔记列表与基本筛选
   - 笔记本基础管理
   - 标签系统基础功能

2. **高优先级（应当实现）**
   - 富文本编辑完整功能
   - 笔记本层级结构
   - 版本历史基础功能
   - 笔记与任务关联

3. **中优先级（可考虑实现）**
   - Markdown支持
   - 图片插入与管理
   - 批量操作功能
   - 高级搜索与筛选

4. **低优先级（有时间再实现）**
   - 语音输入
   - 绘图功能
   - 版本对比高级功能
   - 导出多种格式

#### 里程碑计划

1. **里程碑1：基础功能可用**（第2周末）
   - 笔记创建与编辑基本功能
   - 笔记列表展示与基础筛选
   - 与新架构完全集成

2. **里程碑2：组织功能完善**（第4周末）
   - 笔记本与标签完整管理
   - 富文本编辑器全功能
   - 批量操作支持

3. **里程碑3：高级功能与优化**（第6周末）
   - 版本历史功能
   - 与任务系统集成
   - 性能优化完成
   - 用户体验提升

## 6. 测试与质量保证

### 6.1 测试策略

1. **单元测试**
   - 为所有服务和仓库类编写测试
   - 测试关键业务逻辑函数
   - 目标覆盖率：70%+

2. **组件测试**
   - 测试所有自定义组件
   - 验证UI渲染和交互逻辑
   - 使用快照测试确保视觉一致性

3. **集成测试**
   - 测试模块之间的协作
   - 验证数据流通和状态管理
   - 测试事件系统和通知机制

4. **端到端测试**
   - 测试完整用户流程
   - 验证核心功能场景
   - 确保多组件协同工作

### 6.2 质量指标

1. **性能指标**
   - 笔记列表加载时间：<500ms（50条笔记）
   - 编辑响应时间：<50ms
   - 搜索响应时间：<300ms
   - 内存占用增长：<20MB（100条笔记）

2. **稳定性指标**
   - 崩溃率：<0.1%
   - 数据丢失率：0%
   - 离线可用性：100%

3. **用户体验指标**
   - 任务完成时间：创建笔记<30秒
   - 操作错误率：<5%
   - 用户满意度：>4.5/5（反馈评分）

## 7. 总结与后续发展

### 7.1 与整体产品的协同

笔记功能将与待办任务系统紧密协作，形成完整的个人信息管理生态。两者之间的互联互通将大大提升用户生产力，使应用不仅能管理待办事项，还能作为知识库和信息中心。

### 7.2 未来发展方向

1. **AI增强功能**
   - 智能摘要生成
   - 内容自动分类
   - 智能标签推荐
   - 相关笔记推荐

2. **协作功能**
   - 笔记分享与协作编辑
   - 评论和反馈系统
   - 实时协作功能

3. **知识管理增强**
   - 知识图谱可视化
   - 笔记间关系建立
   - 自动化信息整理
   - 间隔重复学习系统

### 7.3 成功标准

笔记功能的成功将体现在：
- 用户留存率提升
- 每日活跃使用时长增加
- 笔记创建和编辑频率
- 用户反馈和评价改善
- 应用下载量和转化率提升

通过本设计文档的实施，"山记事"应用将拥有一个功能完备、体验优秀的笔记系统，与已有的任务管理功能形成互补，为用户提供全方位的个人生产力工具。 