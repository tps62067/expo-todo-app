# 旧架构迁移待处理清单

本文档记录了项目中仍在使用旧架构的代码部分，以及需要迁移到新架构的任务清单。

## 已完成的迁移

### ✅ 主要页面和核心功能
- [x] `app/(tabs)/index.tsx` - 主页任务列表功能
  - 使用 `useNewTaskService` 替换 `TaskService.getInstance()`
  - 使用新架构的 `getTodayTasks()`, `getActiveTasks()`, `getCompletedTasks()` 方法
  - 修复了数据加载和初始化逻辑

- [x] `app/task/[id].tsx` - 任务详情页面
  - 使用 `useNewTaskService` 替换 `TaskService.getInstance()`
  - 使用新架构的 `getTaskById()`, `updateTaskStatus()`, `updateTask()`, `deleteTask()` 方法
  - 添加了新架构初始化状态检查

- [x] `app/task/create.tsx` - 任务创建页面
  - 已使用新架构的 `newTaskService.createTask()` 方法

### ✅ 数据层修复
- [x] `lib/database/base-dao.ts` - 修复了 `create` 方法的 undefined 值过滤
- [x] `lib/services/NewNoteService.ts` - 修复了笔记服务的标签处理逻辑
- [x] `lib/repositories/NoteRepository.ts` - 修复了笔记仓库的字段映射
- [x] `app/components/TestDataGenerator.tsx` - 添加了系统诊断功能

### ✅ 批量操作功能 (已完成)
**位置:** `app/(tabs)/index.tsx` - 批量删除、恢复、导出功能
**解决方案:** 
- ✅ 在 `NewTaskService` 中实现了批量操作方法
- ✅ 在 `useNewTaskService` Hook 中添加了批量操作接口
- ✅ 主页面批量操作已迁移到新架构

```typescript
// 已实现的新架构方法
✅ newTaskService.batchDelete(taskIds: string[]): Promise<boolean>
✅ newTaskService.batchUpdateStatus(taskIds: string[], status: TaskStatus): Promise<TaskDTO[]>
✅ newTaskService.exportTasks(filters: CompletedTaskFilters): Promise<string>
```

### ✅ 子任务和依赖关系功能 (已完成)
**位置:** `app/task/[id].tsx` - 子任务和依赖关系功能
**解决方案:**
- ✅ 在 `NewTaskService` 中实现了子任务和依赖关系方法
- ✅ 在 `useNewTaskService` Hook 中添加了相关接口
- ✅ 任务详情页面已启用子任务和依赖关系功能

```typescript
// 已实现的新架构方法
✅ getSubtasks(taskId: string): Promise<TaskDTO[]>
✅ getTaskDependencies(taskId: string): Promise<TaskDTO[]>
✅ addSubtask(parentId: string, subtaskData: CreateTaskForm): Promise<TaskDTO>
✅ addDependency(taskId: string, dependsOnId: string): Promise<boolean>
```

### ✅ 工作日志功能 (已完成)
**位置:** `app/task/[id].tsx` - 工作日志相关功能
**解决方案:**
- ✅ 在 `NewTaskService` 中整合了工作日志功能
- ✅ 在 `useNewTaskService` Hook 中添加了工作日志接口
- ✅ 任务详情页面的工作日志功能已迁移到新架构

```typescript
// 已实现的新架构方法
✅ getTaskWorkLogs(taskId: string): Promise<any[]>
✅ addWorkLog(data: WorkLogData): Promise<any>
✅ startWorkTimer(taskId: string, description?: string): Promise<any>
✅ stopWorkTimer(taskId: string): Promise<any>
✅ getActiveTimer(taskId: string): Promise<any>
✅ getWorkLogSummary(taskId: string): Promise<WorkLogSummary>
✅ deleteWorkLog(logId: string): Promise<boolean>
```

### ✅ 任务日志Bug修复 (已完成)
**问题:** 工作日志功能出现"数据库服务未初始化"错误
**原因:** NewTaskService中工作日志方法使用了错误的全局访问方式获取数据库服务
**解决方案:**
- ✅ 在NewTaskService构造函数中添加TaskTimeLogDAO依赖注入
- ✅ 修复容器配置，确保TaskTimeLogDAO正确依赖databaseService
- ✅ 移除所有工作日志方法中的错误全局访问代码
- ✅ 使用注入的taskTimeLogDAO实例替代错误的全局访问

```typescript
// 修复前 (错误的全局访问)
const dbService = (global as any).newAppService?.database || 
  await import('../services/database-service').then(m => m.DatabaseService.getInstance());

// 修复后 (正确的依赖注入)
async getTaskWorkLogs(taskId: string): Promise<any[]> {
  return await this.taskTimeLogDAO.findByTaskId(taskId);
}
```

**验证:** 创建了测试脚本 `scripts/test-task-logs.js` 验证修复效果

### ✅ 数据同步Hook优化 (已完成)
**位置:** `app/hooks/useTaskServiceSync.ts`
**解决方案:** 
- ✅ 将旧的 `TaskService.getInstance()` 替换为新架构的事件监听
- ✅ 使用新架构的 EventBus 监听任务事件
- ✅ 保持与 DataSyncContext 的兼容性

## 待处理的旧架构代码

### ⚠️ 旧服务类标记 (优先级: 低)
**位置:** `lib/services/app-service.ts`
**状态:** 已添加弃用注释
**建议:** 
- ✅ 已添加 @deprecated 注释和迁移指南
- 📋 逐步将依赖此类的代码迁移到新架构
- 📋 在确认所有依赖都迁移后删除

### ❌ 文档中的示例代码 (优先级: 低)
**位置:** 
- `DOC/问题处理.md`
- `DOC/UI设计系统文档.md`
**问题:** 文档中的示例仍使用旧架构
**建议:** 更新文档示例代码

### ✅ 项目管理优化 (基本完成)
**位置:** `app/(tabs)/index.tsx` 中的 `loadProjects` 函数
**状态:** 使用新架构容器获取项目仓库

## 新架构功能完善

### ✅ 批量操作API (已完成)
- ✅ 批量删除任务
- ✅ 批量更新任务状态
- ✅ 批量恢复已完成任务
- ✅ 任务导出功能

### ✅ 子任务和依赖关系 (已完成)
- ✅ 获取子任务列表
- ✅ 获取任务依赖关系
- ✅ 添加子任务
- ✅ 添加依赖关系

### ✅ 工作日志系统 (已完成)
- ✅ 工作日志CRUD操作
- ✅ 工作计时器功能
- ✅ 工作日志统计

### ✅ 事件驱动架构 (已完成)
- ✅ 任务事件发布
- ✅ 事件监听和数据同步
- ✅ 数据变更通知机制

## 迁移状态总结

### 🎉 已完成 (优先级: 高 + 中)
1. ✅ 批量操作功能迁移
2. ✅ 子任务和依赖关系功能
3. ✅ 工作日志功能整合
4. ✅ 事件系统数据同步
5. ✅ 核心页面功能迁移

### 📋 待完成 (优先级: 低)
1. 📋 清理旧服务类
2. 📋 更新文档示例
3. 📋 代码审查和优化

## 测试验证

### ✅ 功能测试
- [x] 主页任务列表加载
- [x] 任务创建和编辑
- [x] 任务状态更新
- [x] 批量操作功能
- [x] 子任务和依赖关系
- [x] 工作日志和计时器
- [x] 数据同步机制

### 📋 性能测试
- [ ] 大量数据加载性能
- [ ] 事件系统性能
- [ ] 内存使用优化

## 更新日志

- **2024-12-XX**: 完成批量操作功能迁移
- **2024-12-XX**: 完成子任务和依赖关系功能
- **2024-12-XX**: 完成工作日志功能整合
- **2024-12-XX**: 完成事件系统数据同步
- **2024-12-XX**: 添加旧架构弃用标记

---

**最后更新:** 2024年12月
**状态:** 核心功能迁移完成，仅剩低优先级清理工作 