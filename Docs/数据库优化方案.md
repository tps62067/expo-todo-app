# ğŸ’¾ æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

**ç‰ˆæœ¬:** 1.0  
**æ—¥æœŸ:** 2025-01-27  
**é€‚ç”¨é¡¹ç›®:** å¾…åŠè®°äº‹åº”ç”¨  
**æŠ€æœ¯æ ˆ:** Expo + React Native + TypeScript + SQLite  

## ğŸ“‹ é—®é¢˜åˆ†æ

æ ¹æ®ä»£ç è¯„å®¡æŠ¥å‘Šï¼Œå½“å‰æ•°æ®åº“å±‚é¢å­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š

1.  **æ•°æ®éªŒè¯ä¸å¤Ÿä¸¥æ ¼**ï¼š`BaseDAO` çš„ `create` æ–¹æ³•ç¼ºå°‘å¯¹è¾“å…¥æ•°æ®çš„éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯çš„æ•°æ®å­˜å…¥æ•°æ®åº“ã€‚
2.  **ç¼ºå°‘æ•°æ®åº“è¿æ¥æ± ç®¡ç†**ï¼šç›´æ¥ä½¿ç”¨ SQLite è¿æ¥ï¼Œåœ¨é«˜å¹¶å‘æˆ–é¢‘ç¹æ“ä½œä¸‹å¯èƒ½å­˜åœ¨è¿æ¥ç®¡ç†é—®é¢˜å’Œæ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆæˆ–è¿æ¥æ³„æ¼é£é™©ã€‚
3.  **æŸ¥è¯¢ä¼˜åŒ–ç©ºé—´**ï¼š
    *   éƒ¨åˆ†å¤æ‚æŸ¥è¯¢æœªä½¿ç”¨è”è¡¨ï¼ˆJOINï¼‰æ“ä½œï¼Œå¯èƒ½å¯¼è‡´å¤šæ¬¡æŸ¥è¯¢ï¼Œå½±å“æ•ˆç‡ã€‚
    *   ç¼ºå°‘å¯¹æŸ¥è¯¢æ€§èƒ½çš„ç›‘æ§å’Œåˆ†ææœºåˆ¶ã€‚
4.  **è½¯åˆ é™¤å®ç°æŸ¥è¯¢å¤æ‚æ€§**ï¼šè™½ç„¶è½¯åˆ é™¤ä¿æŠ¤æ•°æ®ï¼Œä½†åœ¨æŸ¥è¯¢æ—¶éœ€è¦é¢å¤–å¤„ç† `is_deleted` å­—æ®µï¼Œå¯èƒ½ä½¿æŸ¥è¯¢é€»è¾‘å¤æ‚åŒ–ã€‚

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

-   âœ… å»ºç«‹ç»Ÿä¸€çš„æ•°æ®éªŒè¯å±‚ï¼Œç¡®ä¿å…¥åº“æ•°æ®çš„ä¸€è‡´æ€§å’Œæœ‰æ•ˆæ€§ã€‚
-   âœ… ä¼˜åŒ–æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œæé«˜ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚
-   âœ… æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“å¼€é”€ã€‚
-   âœ… å¼•å…¥æŸ¥è¯¢æ€§èƒ½ç›‘æ§ï¼ŒæŒç»­ä¼˜åŒ–æ•°æ®åº“æ“ä½œã€‚
-   âœ… ç®€åŒ–è½¯åˆ é™¤æ•°æ®çš„æŸ¥è¯¢ã€‚

---

## ğŸ”§ è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ•°æ®éªŒè¯å±‚å®ç°

#### 1.1 å¼•å…¥éªŒè¯åº“ (å¦‚ Zod æˆ– Yup)

åœ¨ `BaseDAO` æˆ–æœåŠ¡å±‚æ“ä½œæ•°æ®å‰ï¼Œä½¿ç”¨ç»“æ„åŒ–çš„éªŒè¯åº“å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€‚

```typescript
// lib/models/validators/TaskValidators.ts
import { z } from 'zod';

export const CreateTaskSchema = z.object({
  title: z.string().min(1, "æ ‡é¢˜ä¸èƒ½ä¸ºç©º").max(200, "æ ‡é¢˜è¿‡é•¿"),
  description: z.string().optional(),
  projectId: z.string().uuid().optional(),
  dueDate: z.date().optional(),
  priority: z.nativeEnum(TaskPriority).optional(),
  // ... å…¶ä»–å­—æ®µ
});

export type CreateTaskInput = z.infer<typeof CreateTaskSchema>;

// lib/database/dao/BaseDAO.ts
// ... (å…¶ä»–ä»£ç )
abstract class BaseDAO<T extends BaseEntity, C, U> {
  // ...
  protected abstract getCreateSchema(): z.ZodSchema<C>; // æ–°å¢æŠ½è±¡æ–¹æ³•
  protected abstract getUpdateSchema(): z.ZodSchema<U>; // æ–°å¢æŠ½è±¡æ–¹æ³•

  async create(data: C): Promise<T> {
    try {
      const validatedData = this.getCreateSchema().parse(data);
      // ... åŸæœ‰åˆ›å»ºé€»è¾‘ï¼Œä½¿ç”¨ validatedData
    } catch (error) {
      if (error instanceof z.ZodError) {
        throw new ValidationError("æ•°æ®éªŒè¯å¤±è´¥", error.errors);
      }
      throw error;
    }
  }

  async update(id: string, data: Partial<U>): Promise<T | null> {
    try {
      const validatedData = this.getUpdateSchema().partial().parse(data); // partial for updates
      // ... åŸæœ‰æ›´æ–°é€»è¾‘ï¼Œä½¿ç”¨ validatedData
    } catch (error) {
      if (error instanceof z.ZodError) {
        throw new ValidationError("æ•°æ®æ›´æ–°éªŒè¯å¤±è´¥", error.errors);
      }
      throw error;
    }
  }
}

// lib/database/dao/TaskDAO.ts
// ...
class TaskDAO extends BaseDAO<TaskEntity, CreateTaskInput, UpdateTaskInput> {
  // ...
  protected getCreateSchema() {
    return CreateTaskSchema; // å®ç°æŠ½è±¡æ–¹æ³•
  }
  protected getUpdateSchema() {
    return UpdateTaskSchema; // å®ç°æŠ½è±¡æ–¹æ³• (UpdateTaskSchema éœ€è‡ªè¡Œå®šä¹‰)
  }
  // ...
}
```

### 2. æ•°æ®åº“è¿æ¥ä¸äº‹åŠ¡ç®¡ç†ä¼˜åŒ–

å¯¹äº Expo SQLiteï¼Œå®ƒæœ¬èº«ç®¡ç†è¿æ¥ã€‚ä½†æˆ‘ä»¬å¯ä»¥å°è£…äº‹åŠ¡é€»è¾‘ï¼Œç¡®ä¿å…¶æ­£ç¡®ä½¿ç”¨ã€‚

#### 2.1 ç¡®ä¿äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨
è¯„å®¡æŠ¥å‘Šä¸­å·²æåˆ° `withTransaction` çš„å®ç°æ˜¯è‰¯å¥½çš„ã€‚å…³é”®åœ¨äºç¡®ä¿æ‰€æœ‰å…³è”æ“ä½œéƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

```typescript
// lib/services/TaskService.ts
async assignTaskToProject(taskId: string, projectId: string): Promise<void> {
  return this.database.withTransaction(async () => {
    const task = await this.taskDAO.findById(taskId);
    if (!task) throw new Error('Task not found');
    
    const project = await this.projectDAO.findById(projectId);
    if (!project) throw new Error('Project not found');

    task.projectId = projectId;
    await this.taskDAO.update(taskId, { projectId });

    // å¯èƒ½è¿˜æœ‰å…¶ä»–å…³è”æ“ä½œï¼Œå¦‚æ›´æ–°é¡¹ç›®ä»»åŠ¡æ•°ç­‰
    await this.projectDAO.incrementTaskCount(projectId);
  });
}
```

**æ³¨æ„**: Expo SQLite æœ¬èº«ä¸æä¾›ä¼ ç»Ÿçš„è¿æ¥æ± ã€‚å…¶ API (`SQLite.openDatabase()`) è¿”å›ä¸€ä¸ªæ•°æ®åº“å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç®¡ç†å…¶è‡ªèº«çš„è¿æ¥ã€‚é‡ç‚¹æ˜¯é«˜æ•ˆåœ°ä½¿ç”¨è¿™ä¸ªå•ä¸€è¿æ¥ï¼Œå¹¶é€šè¿‡äº‹åŠ¡æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚é¿å…åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹æ‰“å¼€å’Œå…³é—­æ•°æ®åº“å®ä¾‹ã€‚

### 3. æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

#### 3.1 ç´¢å¼•ä¼˜åŒ–
ç¡®ä¿å¸¸ç”¨æŸ¥è¯¢å­—æ®µå’Œ JOIN æ¡ä»¶å­—æ®µå·²å»ºç«‹ç´¢å¼•ã€‚

```sql
-- ç¤ºä¾‹ï¼šä¸º tasks è¡¨çš„ projectId å’Œ status å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_tasks_project_id ON tasks (project_id);
CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks (status);
CREATE INDEX IF NOT EXISTS idx_tasks_due_date ON tasks (due_date);

-- ç¤ºä¾‹ï¼šä¸º notes è¡¨çš„ task_id åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_notes_task_id ON notes (task_id);
```
åœ¨ `lib/database/migrations/` ä¸­ç®¡ç†è¿™äº›ç´¢å¼•çš„åˆ›å»ºã€‚

#### 3.2 è”è¡¨æŸ¥è¯¢ (JOIN)
å¯¹äºéœ€è¦å…³è”å¤šä¸ªè¡¨æ•°æ®çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ JOIN æ›¿ä»£å¤šæ¬¡å•ç‹¬æŸ¥è¯¢ã€‚

```typescript
// lib/database/dao/TaskDAO.ts
async findTasksWithDetails(options: QueryOptions): Promise<TaskWithProjectAndNoteCount[]> {
  const query = `
    SELECT 
      t.*,
      p.name as project_name,
      (SELECT COUNT(*) FROM notes n WHERE n.task_id = t.id AND n.is_deleted = 0) as note_count
    FROM tasks t
    LEFT JOIN projects p ON t.project_id = p.id
    WHERE t.is_deleted = 0
    -- å…¶ä»–æ¡ä»¶å¦‚ options.filters, options.sortBy ç­‰
    LIMIT ? OFFSET ?;
  `;
  const params = [options.limit, options.offset];
  // æ ¹æ® options.filters åŠ¨æ€æ·»åŠ  WHERE å­å¥å’Œå‚æ•°

  const results = await this.database.getAllAsync<any>(query, params);
  return results.map(row => ({
    // ... è½¬æ¢ row ä¸º TaskWithProjectAndNoteCount ç±»å‹
  }));
}
```

#### 3.3 é¿å… SELECT *
åªé€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“å’Œå¤„ç†å¼€é”€ã€‚

```typescript
// ä¸æ¨è
// const tasks = await this.database.getAllAsync('SELECT * FROM tasks');

// æ¨è
const taskTitles = await this.database.getAllAsync<{id: string, title: string}>(
  'SELECT id, title FROM tasks WHERE status = ?',
  [TaskStatus.TODO]
);
```

#### 3.4 æŸ¥è¯¢åˆ†æ (SQLite EXPLAIN QUERY PLAN)
å¯¹äºå¤æ‚æˆ–æ€§èƒ½ä¸ä½³çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ `EXPLAIN QUERY PLAN` åˆ†æå…¶æ‰§è¡Œè®¡åˆ’ï¼Œæ‰¾å‡ºç“¶é¢ˆã€‚

```typescript
// åœ¨å¼€å‘æˆ–è°ƒè¯•é˜¶æ®µæ‰§è¡Œ
async analyzeQueryPerformance(sql: string, params: any[] = []) {
  const plan = await this.database.getAllAsync(`EXPLAIN QUERY PLAN ${sql}`, params);
  console.log('Query Plan:', plan);
  // æ ¹æ® plan åˆ†ææ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Œæ˜¯å¦æœ‰å…¨è¡¨æ‰«æç­‰
}

// ä½¿ç”¨ç¤ºä¾‹
// await taskDAO.analyzeQueryPerformance('SELECT * FROM tasks WHERE status = ?', ['TODO']);
```

### 4. è½¯åˆ é™¤æŸ¥è¯¢ä¼˜åŒ–

#### 4.1 åˆ›å»ºè§†å›¾ (View)
ä¸ºæ´»åŠ¨è®°å½•åˆ›å»ºè§†å›¾ï¼Œç®€åŒ–æŸ¥è¯¢ï¼Œé¿å…åœ¨æ¯ä¸ªæŸ¥è¯¢ä¸­éƒ½åŠ å…¥ `is_deleted = 0`ã€‚

```sql
-- migrations/00X_create_active_records_views.sql
CREATE VIEW active_tasks AS
SELECT * FROM tasks WHERE is_deleted = 0;

CREATE VIEW active_notes AS
SELECT * FROM notes WHERE is_deleted = 0;
```

ä¹‹åæŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨è§†å›¾ï¼š
```typescript
// lib/database/dao/TaskDAO.ts
async findAllActive(options: QueryOptions): Promise<TaskEntity[]> {
  // ç›´æ¥æŸ¥è¯¢ active_tasks è§†å›¾
  const results = await this.database.getAllAsync<TaskEntity>(
    'SELECT * FROM active_tasks ORDER BY createdAt DESC LIMIT ? OFFSET ?',
    [options.limit, options.offset]
  );
  return results;
}
```
**æ³¨æ„**: è§†å›¾æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œæ˜¯å¯¹æŸ¥è¯¢çš„å°è£…ã€‚å¯¹äºå†™æ“ä½œï¼ˆINSERT, UPDATE, DELETEï¼‰ï¼Œä»éœ€æ“ä½œåŸºè¡¨ã€‚

### 5. æ•°æ®åº“æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

#### 5.1 è®°å½•æ…¢æŸ¥è¯¢
å°è£…æ•°æ®åº“æ‰§è¡Œæ–¹æ³•ï¼Œè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„æŸ¥è¯¢ã€‚

```typescript
// lib/database/SQLiteDatabase.ts (æˆ–ç±»ä¼¼å°è£…ç±»)
async getAllAsync<T>(sql: string, params: any[] = []): Promise<T[]> {
  const startTime = performance.now();
  try {
    return await this.db.getAllAsync<T>(sql, params);
  } finally {
    const duration = performance.now() - startTime;
    if (duration > SLOW_QUERY_THRESHOLD_MS) { // SLOW_QUERY_THRESHOLD_MS = 50ms ä¾‹å¦‚
      console.warn(`Slow query (${duration.toFixed(2)}ms): ${sql}`, params);
      // å¯ä»¥é›†æˆåˆ°æ›´å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ
    }
  }
}
// å¯¹ runAsync, getAsync ç­‰æ–¹æ³•ä¹Ÿåšç±»ä¼¼å¤„ç†
```

#### 5.2 å®šæœŸæ•°æ®åº“ç»´æŠ¤ (PRAGMA optimize)
SQLite æä¾›äº† `PRAGMA optimize;` å‘½ä»¤ï¼Œå¯ä»¥è¿è¡Œä¸€äº›ä¼˜åŒ–æ“ä½œã€‚

```typescript
// å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æ—¶æˆ–ä½å³°æœŸæ‰§è¡Œ
async optimizeDatabase() {
  try {
    await this.database.runAsync('PRAGMA optimize;');
    console.log('Database optimization complete.');
  } catch (error) {
    console.error('Database optimization failed:', error);
  }
}
```

---

## ğŸ“¦ å®æ–½è®¡åˆ’

### Phase 1: æ•°æ®éªŒè¯ä¸åŸºç¡€ä¼˜åŒ– (1å‘¨)
-   [ ] å¼•å…¥ Zod å¹¶ä¸ºæ ¸å¿ƒæ¨¡å‹æ·»åŠ éªŒè¯ Schemaã€‚
-   [ ] åœ¨ `BaseDAO` ä¸­é›†æˆæ•°æ®éªŒè¯é€»è¾‘ã€‚
-   [ ] Reviewå¹¶ç¡®ä¿å…³é”®çš„è·¨è¡¨æ“ä½œä½¿ç”¨äº‹åŠ¡ã€‚
-   [ ] æ·»åŠ åŸºç¡€ç´¢å¼• (ä¸»é”®ã€å¤–é”®ã€å¸¸ç”¨æŸ¥è¯¢å­—æ®µ)ã€‚

### Phase 2: æŸ¥è¯¢é‡æ„ä¸è§†å›¾ (1.5å‘¨)
-   [ ] è¯†åˆ«å¹¶é‡æ„æ€§èƒ½æ•æ„Ÿçš„æŸ¥è¯¢ï¼Œä¼˜å…ˆä½¿ç”¨ JOINã€‚
-   [ ] æ¨å¹¿ `SELECT <specific_columns>` æ›¿ä»£ `SELECT *`ã€‚
-   [ ] ä¸ºè½¯åˆ é™¤è¡¨åˆ›å»º `active_...` è§†å›¾å¹¶æ›´æ–°DAOæ–¹æ³•ã€‚
-   [ ] å®ç°æŸ¥è¯¢åˆ†æè¾…åŠ©å‡½æ•°ã€‚

### Phase 3: æ€§èƒ½ç›‘æ§ä¸ç»´æŠ¤ (1å‘¨)
-   [ ] å®ç°æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•ã€‚
-   [ ] é›†æˆ `PRAGMA optimize` åˆ°åº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸­ã€‚
-   [ ] ä½¿ç”¨ `EXPLAIN QUERY PLAN` åˆ†æå‡ ä¸ªæ ¸å¿ƒæŸ¥è¯¢å¹¶è®°å½•ä¼˜åŒ–å‰åå¯¹æ¯”ã€‚

### Phase 4: æµ‹è¯•ä¸æ–‡æ¡£ (1å‘¨)
-   [ ] é’ˆå¯¹æ–°çš„éªŒè¯é€»è¾‘å’ŒæŸ¥è¯¢æ–¹æ³•è¡¥å……å•å…ƒ/é›†æˆæµ‹è¯•ã€‚
-   [ ] æ›´æ–°æ•°æ®åº“ç›¸å…³æ–‡æ¡£ï¼ŒåŒ…æ‹¬ Schemaã€ç´¢å¼•ç­–ç•¥ã€è§†å›¾ä¿¡æ¯ã€‚
-   [ ] è¿›è¡Œä¸€è½®é’ˆå¯¹æ€§çš„æ€§èƒ½æµ‹è¯•ã€‚

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

-   **æ•°æ®è´¨é‡æå‡**ï¼šé€šè¿‡ä¸¥æ ¼çš„æ•°æ®éªŒè¯ï¼Œå‡å°‘è„æ•°æ®å’Œæ½œåœ¨é”™è¯¯ã€‚
-   **æŸ¥è¯¢æ€§èƒ½æå‡**ï¼šé€šè¿‡ç´¢å¼•ã€JOINä¼˜åŒ–å’Œè§†å›¾ï¼ŒåŠ å¿«æ•°æ®æ£€ç´¢é€Ÿåº¦ï¼Œé™ä½UIå“åº”å»¶è¿Ÿã€‚
-   **åº”ç”¨ç¨³å®šæ€§å¢å¼º**ï¼šæ›´å¯é çš„äº‹åŠ¡ç®¡ç†å’Œæ•°æ®éªŒè¯ã€‚
-   **å¯ç»´æŠ¤æ€§æ”¹å–„**ï¼šè§†å›¾ç®€åŒ–æŸ¥è¯¢é€»è¾‘ï¼Œç»“æ„åŒ–éªŒè¯ä½¿ä»£ç æ›´æ¸…æ™°ã€‚
-   **é—®é¢˜å®šä½åŠ é€Ÿ**ï¼šæ…¢æŸ¥è¯¢æ—¥å¿—å’ŒæŸ¥è¯¢è®¡åˆ’åˆ†ææœ‰åŠ©äºå¿«é€Ÿå®šä½å’Œè§£å†³æ•°æ®åº“ç“¶é¢ˆã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

-   **Expo SQLite é™åˆ¶**: å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ SQLite å®ç°ï¼Œä¸æ”¯æŒæ‰€æœ‰é«˜çº§æ•°æ®åº“åŠŸèƒ½ã€‚ä¼˜åŒ–éœ€åœ¨æ­¤èŒƒå›´å†…è¿›è¡Œã€‚
-   **è¿‡åº¦ç´¢å¼•**: è¿‡å¤šçš„ç´¢å¼•ä¼šå¢åŠ å†™æ“ä½œçš„å¼€é”€ï¼Œéœ€è¦æƒè¡¡è¯»å†™æ€§èƒ½ã€‚
-   **è¿ç§»ç®¡ç†**: æ‰€æœ‰æ•°æ®åº“ç»“æ„å˜æ›´ï¼ˆè¡¨ã€ç´¢å¼•ã€è§†å›¾ï¼‰éƒ½åº”é€šè¿‡è¿ç§»è„šæœ¬è¿›è¡Œç®¡ç†ã€‚ 